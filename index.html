<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BTX Clinic ‚Ä¢ Dr. Orlando Abreu Gomes da Silva</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0b1119;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --text:#e8f0ff;
      --muted:rgba(232,240,255,.70);
      --muted2:rgba(232,240,255,.55);
      --accent:#21f3a6; /* verde tech */
      --accent2:#14c98a;
      --danger:#ff496a;
      --warn:#ffd166;
      --ok:#7CFFB2;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 5%, rgba(33,243,166,.08), transparent 55%),
        radial-gradient(900px 700px at 95% 30%, rgba(33,243,166,.06), transparent 60%),
        radial-gradient(1200px 800px at 40% 110%, rgba(33,243,166,.05), transparent 60%),
        linear-gradient(180deg, #05070a, var(--bg));
      overflow-x:hidden;
    }

    /* ====== LANDING (fora do sistema) ====== */
    .landing{
      min-height:100vh;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:24px;
      padding:28px;
      position:relative;
    }
    @media (max-width: 980px){
      .landing{grid-template-columns:1fr; padding:18px; gap:16px;}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 250px at 20% 0%, rgba(33,243,166,.18), transparent 55%);
      pointer-events:none;
      opacity:.65;
    }
    .card > *{position:relative; z-index:1;}

    .hero{
      padding:22px 22px 18px 22px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .brandRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brandMark{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .dot{
      width:11px; height:11px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(33,243,166,.16), 0 0 22px rgba(33,243,166,.35);
    }
    .brandTitle{
      font-weight:800;
      letter-spacing:.4px;
    }
    .badge{
      font-family:var(--mono);
      font-size:12px;
      color: rgba(232,240,255,.85);
      border:1px solid var(--line2);
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.20);
    }

    .heroMain{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:18px;
      align-items:center;
    }
    @media (max-width: 980px){
      .heroMain{grid-template-columns:1fr; }
    }

    .proPhotoWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-start;
    }
    .proPhoto{
      width:160px; height:190px;
      border-radius:20px;
      border:1px solid var(--line2);
      background:
        radial-gradient(220px 220px at 30% 20%, rgba(33,243,166,.22), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.25));
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .proPhoto img{width:100%; height:100%; object-fit:cover; display:block;}
    .photoHint{
      font-size:12px;
      color:var(--muted2);
    }
    .btn{
      cursor:pointer;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.26);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(33,243,166,.45); background: rgba(0,0,0,.33);}
    .btn:active{transform: translateY(0px);}
    .btnAccent{
      border-color: rgba(33,243,166,.55);
      background: linear-gradient(180deg, rgba(33,243,166,.16), rgba(0,0,0,.25));
      box-shadow: 0 0 0 6px rgba(33,243,166,.08);
    }
    .btnDanger{border-color: rgba(255,73,106,.55);}
    .btnSmall{padding:8px 10px; border-radius:12px; font-size:13px;}
    .btnGhost{background: rgba(255,255,255,.04);}

    .headline{
      margin:0;
      font-size:26px;
      line-height:1.08;
      letter-spacing:.2px;
    }
    .subline{
      margin:0;
      color:var(--muted);
      font-size:14.5px;
      line-height:1.45;
    }

    .gridInfo{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:6px;
    }
    @media (max-width: 980px){.gridInfo{grid-template-columns:1fr}}
    .infoBox{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      background: rgba(0,0,0,.18);
    }
    .infoBox h4{
      margin:0 0 8px 0;
      font-size:13px;
      color: rgba(232,240,255,.85);
      letter-spacing:.2px;
    }
    .infoBox ul{
      margin:0;
      padding-left:18px;
      color: var(--muted);
      font-size:13px;
      line-height:1.55;
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: rgba(232,240,255,.88);
    }
    .pill strong{color:var(--accent); font-weight:900;}

    .rightPanel{
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .sectionTitle h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      color: rgba(232,240,255,.88);
    }
    .mini{
      font-size:12px;
      color:var(--muted2);
      font-family:var(--mono);
    }

    .faqList{
      display:grid;
      gap:10px;
    }
    details.faq{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(0,0,0,.18);
    }
    details.faq summary{
      cursor:pointer;
      font-weight:800;
      color: rgba(232,240,255,.92);
      list-style:none;
    }
    details.faq summary::-webkit-details-marker{display:none}
    details.faq p{
      margin:10px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.55;
    }

    /* Login canto inferior */
    .loginDock{
      position:fixed;
      right:18px;
      bottom:18px;
      width:min(420px, calc(100vw - 36px));
      z-index:50;
    }
    .loginDockInner{
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(33,243,166,.35);
      background: rgba(6,9,12,.75);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 65px rgba(0,0,0,.6);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .loginDockInner input{
      flex:1;
      border-radius:14px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.30);
      color:var(--text);
      padding:11px 12px;
      font-size:14px;
      outline:none;
    }
    .loginDockInner input:focus{border-color: rgba(33,243,166,.55); box-shadow: 0 0 0 6px rgba(33,243,166,.10);}
    .hintDock{
      margin-top:8px;
      font-size:12px;
      color: rgba(232,240,255,.55);
      text-align:right;
    }

    /* ====== APP ====== */
    .app{
      min-height:100vh;
      display:none;
    }
    .appShell{
      display:grid;
      grid-template-columns: 300px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .appShell{grid-template-columns:1fr;}
    }

    .sidebar{
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      padding:18px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
    }
    @media (max-width: 980px){
      .sidebar{position:relative; height:auto; border-right:none; border-bottom:1px solid var(--line);}
    }

    .sideTop{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:14px;
    }
    .sidePhoto{
      width:54px; height:54px; border-radius:16px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.26);
      overflow:hidden;
      flex:0 0 auto;
    }
    .sidePhoto img{width:100%; height:100%; object-fit:cover; display:block;}
    .sideName{
      display:flex; flex-direction:column; gap:2px;
    }
    .sideName strong{font-size:13.5px;}
    .sideName span{font-size:12px; color:var(--muted2); font-family:var(--mono);}
    .nav{
      display:grid;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      width:100%;
      text-align:left;
      padding:11px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: rgba(232,240,255,.90);
      cursor:pointer;
      font-weight:800;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(33,243,166,.40);
      background: rgba(0,0,0,.25);
    }
    .nav button.active{
      border-color: rgba(33,243,166,.65);
      background: linear-gradient(180deg, rgba(33,243,166,.14), rgba(0,0,0,.22));
      box-shadow: 0 0 0 6px rgba(33,243,166,.08);
    }
    .nav small{color: rgba(232,240,255,.55); font-family:var(--mono); font-weight:700;}

    .sideActions{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .main{
      padding:18px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .topbar h2{
      margin:0;
      font-size:16px;
      letter-spacing:.25px;
    }
    .topbar .right{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }

    .panel{
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      border-radius:var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.03);
    }
    .panelHeader strong{font-size:13px; letter-spacing:.2px;}
    .panelBody{padding:14px;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .rowBetween{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 180px;
      flex: 1;
    }
    label{font-size:12px; color:var(--muted2); font-family:var(--mono);}
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.28);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:110px; resize:vertical;}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(33,243,166,.55);
      box-shadow: 0 0 0 6px rgba(33,243,166,.10);
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      color: rgba(232,240,255,.85);
      font-family:var(--mono);
      font-size:12px;
      background: rgba(255,255,255,.03);
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .table tr:last-child td{border-bottom:none;}
    .tag{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;
      font-family:var(--mono);
      color: rgba(232,240,255,.88);
      white-space:nowrap;
    }
    .tag.ok{border-color: rgba(124,255,178,.35);}
    .tag.warn{border-color: rgba(255,209,102,.35);}
    .tag.bad{border-color: rgba(255,73,106,.35);}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono);}

    .split{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){.split{grid-template-columns:1fr;}}

    /* Odontograma */
    .odontogram{
      display:grid;
      gap:10px;
    }
    .toothGrid{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:8px;
      padding:10px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    .tooth{
      border-radius:14px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.22);
      padding:10px 8px;
      cursor:pointer;
      user-select:none;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      justify-content:center;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      min-height:70px;
    }
    .tooth:hover{transform: translateY(-1px); border-color: rgba(33,243,166,.40);}
    .tooth .id{font-family:var(--mono); font-size:12px; color: rgba(232,240,255,.78);}
    .tooth .state{
      font-family:var(--mono);
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: rgba(232,240,255,.86);
    }
    .tooth[data-state="normal"] .state{border-color: rgba(33,243,166,.28);}
    .tooth[data-state="carie"] .state{border-color: rgba(255,209,102,.42); color: rgba(255,209,102,.95);}
    .tooth[data-state="restaurado"] .state{border-color: rgba(124,255,178,.38); color: rgba(124,255,178,.95);}
    .tooth[data-state="ausente"] .state{border-color: rgba(255,73,106,.38); color: rgba(255,73,106,.95);}
    .tooth[data-state="canal"] .state{border-color: rgba(33,243,166,.55); color: rgba(33,243,166,.95);}

    .legend{
      display:flex; flex-wrap:wrap; gap:8px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:18px;
      bottom:18px;
      z-index:200;
      display:grid;
      gap:10px;
      pointer-events:none;
    }
    .toast .t{
      pointer-events:none;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(33,243,166,.28);
      background: rgba(6,9,12,.82);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      color: rgba(232,240,255,.92);
      font-size:13px;
      max-width:min(560px, calc(100vw - 36px));
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:220;
    }
    .modal{
      width:min(860px, 100%);
      border-radius:22px;
      border:1px solid var(--line2);
      background: rgba(8,10,14,.92);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      background: rgba(255,255,255,.03);
    }
    .modalHead strong{font-size:13px; letter-spacing:.2px;}
    .modalBody{padding:14px;}
    .modalFoot{
      padding:14px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      background: rgba(255,255,255,.02);
    }

    /* ====== PRINT DOCUMENT ====== */
    /* A4 look "inquebr√°vel" (sem quebrar o container em p√°ginas) */
    .docA4{
      width: 210mm;
      min-height: 297mm;
      margin: 0 auto;
      padding: 14mm 14mm;
      background:#ffffff;
      color:#0b0f14;
      border-radius: 10mm;
      border: 1.4mm solid #1f6fff; /* borda azul */
      box-shadow: none;
      position:relative;
    }
    .docTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10mm;
      padding-bottom: 6mm;
      border-bottom: .4mm solid rgba(11,15,20,.15);
      margin-bottom: 6mm;
    }
    .docBrand{
      display:flex; flex-direction:column; gap:2mm;
    }
    .docBrand h1{
      margin:0;
      font-size: 16pt;
      letter-spacing:.3pt;
    }
    .docBrand .docMeta{
      font-size:10pt;
      color: rgba(11,15,20,.75);
      line-height:1.35;
    }
    .docTitle{
      font-size: 13pt;
      font-weight: 800;
      margin: 0;
      text-align:right;
      color:#0b0f14;
    }
    .docSection{
      margin-top: 4mm;
      font-size: 11pt;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .docFooter{
      position:absolute;
      left:14mm; right:14mm; bottom:12mm;
      border-top: .4mm solid rgba(11,15,20,.15);
      padding-top: 4mm;
      font-size: 9pt;
      color: rgba(11,15,20,.72);
      display:flex;
      justify-content:space-between;
      gap:10mm;
    }
    .docNoBreak{
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* App print: nunca imprime a UI */
    @media print{
      body{background:#fff !important;}
      .landing, .app, .loginDock, .toast, .modalBack{display:none !important;}
    }
  </style>
</head>
<body>

  <!-- ====== LANDING ====== -->
  <section class="landing" id="landing">
    <div class="card">
      <div class="hero">
        <div class="brandRow">
          <div class="brandMark">
            <div class="dot"></div>
            <div>
              <div class="brandTitle">BTX Clinic</div>
              <div class="mini">offline ‚Ä¢ r√°pido ‚Ä¢ premium</div>
            </div>
          </div>
          <div class="badge" title="Vers√£o local no seu dispositivo">v1.0 ‚Ä¢ LocalStorage</div>
        </div>

        <div class="heroMain">
          <div class="proPhotoWrap">
            <div class="proPhoto" id="landingPhoto">
              <span class="mono muted">FOTO<br/>PROFISSIONAL</span>
            </div>
            <div class="row">
              <label class="btn btnSmall btnGhost">
                <input id="photoInput" type="file" accept="image/*" style="display:none"/>
                üì∑ Enviar foto
              </label>
              <button class="btn btnSmall btnDanger btnGhost" id="removePhotoBtn" type="button">üóëÔ∏è Remover</button>
            </div>
            <div class="photoHint">Dica: use uma foto vertical (estilo crach√°). Ela fica salva no aparelho.</div>
          </div>

          <div>
            <h1 class="headline">Dr. Orlando Abreu Gomes da Silva</h1>
            <p class="subline">
              Graduado em Odontologia (2010) ‚Ä¢ P√≥s-gradua√ß√£o em Cirurgia e Traumatologia Buco-Maxilo-Facial (2016) ‚Ä¢
              P√≥s-graduado em Sa√∫de Coletiva ‚Ä¢ P√≥s-graduando em Patologia ‚Ä¢ Graduando em Medicina ‚Ä¢
              Graduando em Engenharia da Computa√ß√£o e An√°lise de Sistemas.
            </p>

            <div class="gridInfo">
              <div class="infoBox">
                <h4>Destaque profissional</h4>
                <ul>
                  <li><strong>Fundador</strong> da <span style="color:var(--accent); font-weight:900;">BTX Tech</span></li>
                  <li>Startup com foco em <strong>biotecnologia</strong> e solu√ß√µes digitais em sa√∫de</li>
                  <li>Atua√ß√£o cl√≠nica + tecnologia (software offline-first)</li>
                </ul>
              </div>
              <div class="infoBox">
                <h4>O que este sistema faz</h4>
                <ul>
                  <li><strong>Agenda</strong> completa com contagem por dia</li>
                  <li><strong>Pacientes</strong> + ficha cl√≠nica + hist√≥rico</li>
                  <li><strong>Odontograma</strong> interativo</li>
                  <li><strong>Receita</strong>, <strong>Atestado</strong>, <strong>Or√ßamento</strong> em A4 sem quebrar</li>
                </ul>
              </div>
            </div>

            <div class="pillRow">
              <div class="pill"><strong>VERDE</strong> tech</div>
              <div class="pill">grafite</div>
              <div class="pill">offline</div>
              <div class="pill">A4 premium</div>
              <div class="pill">backup</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="rightPanel">
        <div class="sectionTitle">
          <h3>D√∫vidas comuns (buco-maxilo)</h3>
          <div class="mini">mini FAQ</div>
        </div>

        <div class="faqList">
          <details class="faq">
            <summary>Quando devo procurar um buco-maxilo?</summary>
            <p>Quando h√° fraturas faciais, dentes inclusos complexos, infec√ß√µes profundas, altera√ß√µes √≥sseas, dores persistentes em ATM, cirurgias em face e casos que exigem planejamento cir√∫rgico avan√ßado.</p>
          </details>

          <details class="faq">
            <summary>Dor na ATM pode ser trauma?</summary>
            <p>Pode sim. Pancada no queixo pode sobrecarregar a articula√ß√£o, gerando dor, estalos, limita√ß√£o de abertura e irradia√ß√£o. Avalia√ß√£o cl√≠nica + exames quando indicado orientam o manejo.</p>
          </details>

          <details class="faq">
            <summary>Como o sistema evita ‚Äúbagun√ßa‚Äù na impress√£o?</summary>
            <p>Os documentos s√£o montados em um layout A4 com borda e quebra controlada. A impress√£o √© aberta em uma janela √∫nica para evitar duplica√ß√µes e manter o padr√£o.</p>
          </details>
        </div>

        <div class="infoBox">
          <h4>Seguran√ßa r√°pida</h4>
          <ul>
            <li>Login por senha local (voc√™ pode trocar depois)</li>
            <li>Dados ficam no dispositivo (offline)</li>
            <li>Export/Import para backup</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Login dock canto inferior -->
  <div class="loginDock" id="loginDock">
    <div class="loginDockInner">
      <input id="loginPass" type="password" placeholder="Senha de acesso (padr√£o: 1234)"/>
      <button class="btn btnAccent" id="loginBtn" type="button">Entrar ‚ñ∏</button>
    </div>
    <div class="hintDock">Voc√™ pode mudar a senha no menu ‚ÄúConfig‚Äù.</div>
  </div>

  <!-- ====== APP ====== -->
  <section class="app" id="app">
    <div class="appShell">
      <aside class="sidebar">
        <div class="sideTop">
          <div class="sidePhoto" id="sidePhoto"></div>
          <div class="sideName">
            <strong id="proNameSide">Dr. Orlando Abreu Gomes da Silva</strong>
            <span id="proTagSide">BTX Clinic ‚Ä¢ offline</span>
          </div>
        </div>

        <div class="nav" id="nav">
          <button data-view="agenda" class="active">Agenda <small id="navAgendaCount">0 hoje</small></button>
          <button data-view="patients">Pacientes <small id="navPatientsCount">0</small></button>
          <button data-view="chart">Odontograma <small class="mono">FDI</small></button>
          <button data-view="docs">Documentos <small class="mono">A4</small></button>
          <button data-view="config">Config <small class="mono">backup</small></button>
        </div>

        <div class="sideActions">
          <button class="btn btnSmall btnGhost" id="quickTodayBtn" type="button">üìÖ Hoje</button>
          <button class="btn btnSmall btnGhost" id="quickNewApptBtn" type="button">‚ûï Agendar</button>
          <button class="btn btnSmall btnDanger btnGhost" id="logoutBtn" type="button">Sair</button>
        </div>

        <div style="margin-top:14px;" class="infoBox">
          <h4>Profissional</h4>
          <ul>
            <li><strong>BTX Tech</strong> ‚Ä¢ Startup em biotecnologia</li>
            <li>Odontologia (2010) ‚Ä¢ BMF (2016)</li>
            <li>Sa√∫de Coletiva ‚Ä¢ Patologia ‚Ä¢ Medicina ‚Ä¢ Computa√ß√£o</li>
          </ul>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <h2 id="viewTitle">Agenda</h2>
          <div class="right">
            <button class="btn btnSmall btnGhost" id="backupBtn" type="button">‚¨áÔ∏è Exportar</button>
            <label class="btn btnSmall btnGhost">
              <input id="restoreInput" type="file" accept="application/json" style="display:none"/>
              ‚¨ÜÔ∏è Importar
            </label>
          </div>
        </div>

        <!-- ====== AGENDA VIEW ====== -->
        <section class="panel" id="view-agenda">
          <div class="panelHeader">
            <strong>Agenda ‚Ä¢ vis√£o do dia e semana</strong>
            <div class="row">
              <button class="btn btnSmall btnGhost" id="prevDayBtn" type="button">‚óÇ</button>
              <div class="tag" id="agendaDateTag">‚Äî</div>
              <button class="btn btnSmall btnGhost" id="nextDayBtn" type="button">‚ñ∏</button>
              <button class="btn btnSmall btnAccent" id="addApptBtn" type="button">‚ûï Novo</button>
            </div>
          </div>

          <div class="panelBody">
            <div class="split">
              <div>
                <div class="row">
                  <div class="field">
                    <label>Data selecionada</label>
                    <input id="agendaDate" type="date"/>
                  </div>
                  <div class="field">
                    <label>Busca (nome / telefone / observa√ß√£o)</label>
                    <input id="agendaSearch" type="text" placeholder="Ex.: Maria, (91), retorno..."/>
                  </div>
                  <div class="field" style="max-width:220px;">
                    <label>Status</label>
                    <select id="agendaFilterStatus">
                      <option value="">Todos</option>
                      <option value="confirmado">Confirmado</option>
                      <option value="pendente">Pendente</option>
                      <option value="faltou">Faltou</option>
                      <option value="concluido">Conclu√≠do</option>
                    </select>
                  </div>
                </div>

                <div style="margin-top:12px;" class="rowBetween">
                  <div class="row">
                    <div class="tag" id="countDayTag">0 pacientes no dia</div>
                    <div class="tag" id="countWeekTag">0 na semana</div>
                  </div>
                  <div class="mini">Tudo salva automaticamente (offline).</div>
                </div>

                <div style="margin-top:12px;">
                  <table class="table" id="agendaTable">
                    <thead>
                      <tr>
                        <th style="width:90px;">Hora</th>
                        <th>Paciente</th>
                        <th style="width:140px;">Status</th>
                        <th style="width:160px;">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                  <div class="mini" style="margin-top:8px;">Dica: clique em ‚ÄúEditar‚Äù pra abrir a ficha r√°pida e linkar paciente.</div>
                </div>
              </div>

              <div class="panel" style="background:rgba(0,0,0,.14); border-radius:22px;">
                <div class="panelHeader">
                  <strong>Resumo do dia</strong>
                  <div class="mini mono" id="daySummaryMini">‚Äî</div>
                </div>
                <div class="panelBody">
                  <div class="infoBox">
                    <h4>Vis√£o inteligente</h4>
                    <ul>
                      <li>Voc√™ enxerga <strong>quantos pacientes</strong> tem no dia</li>
                      <li>Filtro por status e busca r√°pida</li>
                      <li>Atalho para abrir <strong>ficha do paciente</strong></li>
                      <li>Agenda desenhada pra tablet</li>
                    </ul>
                  </div>
                  <div style="margin-top:12px;" class="infoBox">
                    <h4>Fluxo sugerido</h4>
                    <ul>
                      <li>Agendar ‚Üí confirmar ‚Üí atender</li>
                      <li>No atendimento: ficha + odontograma</li>
                      <li>Finalizar: receita/atestado/or√ßamento</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ====== PATIENTS VIEW ====== -->
        <section class="panel" id="view-patients" style="display:none;">
          <div class="panelHeader">
            <strong>Pacientes ‚Ä¢ ficha cl√≠nica</strong>
            <div class="row">
              <button class="btn btnSmall btnAccent" id="addPatientBtn" type="button">‚ûï Novo paciente</button>
            </div>
          </div>
          <div class="panelBody">
            <div class="split">
              <div>
                <div class="row">
                  <div class="field">
                    <label>Busca paciente</label>
                    <input id="patientSearch" type="text" placeholder="Nome, telefone, observa√ß√£o..."/>
                  </div>
                  <div class="field" style="max-width:220px;">
                    <label>Ordenar</label>
                    <select id="patientSort">
                      <option value="name">Nome (A‚ÜíZ)</option>
                      <option value="recent">Mais recente</option>
                    </select>
                  </div>
                </div>

                <div style="margin-top:12px;">
                  <table class="table" id="patientsTable">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th style="width:140px;">Telefone</th>
                        <th style="width:130px;">√ölt. atualiza√ß√£o</th>
                        <th style="width:170px;">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="panel" style="background:rgba(0,0,0,.14); border-radius:22px;">
                <div class="panelHeader">
                  <strong>Ficha (selecionado)</strong>
                  <div class="tag" id="selectedPatientTag">Nenhum</div>
                </div>
                <div class="panelBody">
                  <div class="row">
                    <div class="field">
                      <label>Nome</label>
                      <input id="pName" type="text" placeholder="Nome completo"/>
                    </div>
                    <div class="field" style="max-width:240px;">
                      <label>Telefone</label>
                      <input id="pPhone" type="text" placeholder="(91) 99999-9999"/>
                    </div>
                  </div>
                  <div class="row">
                    <div class="field">
                      <label>CPF (opcional)</label>
                      <input id="pCpf" type="text" placeholder="000.000.000-00"/>
                    </div>
                    <div class="field" style="max-width:240px;">
                      <label>Data de nascimento</label>
                      <input id="pDob" type="date"/>
                    </div>
                  </div>
                  <div class="row">
                    <div class="field">
                      <label>Endere√ßo (opcional)</label>
                      <input id="pAddress" type="text" placeholder="Cidade, bairro, rua..."/>
                    </div>
                  </div>
                  <div class="row">
                    <div class="field">
                      <label>Anamnese / Observa√ß√µes cl√≠nicas</label>
                      <textarea id="pNotes" placeholder="Queixa principal, hist√≥rico, alergias, condi√ß√µes, etc."></textarea>
                    </div>
                  </div>

                  <div class="rowBetween" style="margin-top:10px;">
                    <div class="row">
                      <button class="btn btnSmall btnAccent" id="savePatientBtn" type="button">üíæ Salvar ficha</button>
                      <button class="btn btnSmall btnGhost" id="openOdontoFromPatientBtn" type="button">ü¶∑ Abrir odontograma</button>
                    </div>
                    <div class="mini">Atualiza e salva autom√°tico no dispositivo.</div>
                  </div>

                  <div style="margin-top:12px;" class="infoBox">
                    <h4>Hist√≥rico</h4>
                    <ul id="pHistory" style="margin:0; padding-left:18px;"></ul>
                    <div class="mini" id="pHistoryEmpty">Sem hist√≥rico ainda.</div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ====== ODONTOGRAM VIEW ====== -->
        <section class="panel" id="view-chart" style="display:none;">
          <div class="panelHeader">
            <strong>Odontograma ‚Ä¢ marca√ß√£o por dente</strong>
            <div class="row">
              <div class="tag" id="odontoPatientTag">Paciente: ‚Äî</div>
              <button class="btn btnSmall btnGhost" id="odontoResetBtn" type="button">‚Ü∫ Limpar</button>
              <button class="btn btnSmall btnAccent" id="odontoSaveBtn" type="button">üíæ Salvar</button>
            </div>
          </div>
          <div class="panelBody">
            <div class="odontogram">
              <div class="legend">
                <span class="tag ok">normal</span>
                <span class="tag warn">c√°rie</span>
                <span class="tag ok">restaurado</span>
                <span class="tag bad">ausente</span>
                <span class="tag" style="border-color: rgba(33,243,166,.65);">canal</span>
                <span class="tag muted">Clique no dente para alternar</span>
              </div>

              <div class="infoBox">
                <h4>Como funciona</h4>
                <ul>
                  <li>Clique no dente para alternar estados: normal ‚Üí c√°rie ‚Üí restaurado ‚Üí canal ‚Üí ausente ‚Üí normal</li>
                  <li>Fica salvo por paciente</li>
                  <li>Depois d√° pra imprimir no documento se quiser (evolu√ß√£o futura)</li>
                </ul>
              </div>

              <div class="panel" style="background:rgba(0,0,0,.14); border-radius:22px;">
                <div class="panelHeader">
                  <strong>Arcada superior (FDI)</strong>
                  <div class="mini">18 ‚Üí 11 | 21 ‚Üí 28</div>
                </div>
                <div class="panelBody">
                  <div class="toothGrid" id="upperGrid"></div>
                </div>
              </div>

              <div class="panel" style="background:rgba(0,0,0,.14); border-radius:22px;">
                <div class="panelHeader">
                  <strong>Arcada inferior (FDI)</strong>
                  <div class="mini">48 ‚Üí 41 | 31 ‚Üí 38</div>
                </div>
                <div class="panelBody">
                  <div class="toothGrid" id="lowerGrid"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ====== DOCS VIEW ====== -->
        <section class="panel" id="view-docs" style="display:none;">
          <div class="panelHeader">
            <strong>Documentos ‚Ä¢ receitu√°rio ‚Ä¢ atestado ‚Ä¢ or√ßamento</strong>
            <div class="row">
              <button class="btn btnSmall btnGhost" id="docClearBtn" type="button">Limpar</button>
              <button class="btn btnSmall btnAccent" id="docPrintBtn" type="button">üñ®Ô∏è Imprimir A4</button>
            </div>
          </div>
          <div class="panelBody">
            <div class="split">
              <div>
                <div class="row">
                  <div class="field">
                    <label>Tipo de documento</label>
                    <select id="docType">
                      <option value="receita">Receitu√°rio</option>
                      <option value="atestado">Atestado</option>
                      <option value="orcamento">Or√ßamento</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Paciente</label>
                    <select id="docPatient"></select>
                  </div>
                  <div class="field" style="max-width:220px;">
                    <label>Data</label>
                    <input id="docDate" type="date"/>
                  </div>
                </div>

                <div id="rxQuickWrap" style="margin-top:12px;" class="panel">
                  <div class="panelHeader">
                    <strong>Receita inteligente ‚Ä¢ modelos r√°pidos</strong>
                    <div class="mini">salva a √∫ltima sele√ß√£o</div>
                  </div>
                  <div class="panelBody">
                    <div class="row">
                      <button class="btn btnSmall btnGhost" data-rx="analgesico" type="button">Analg√©sico</button>
                      <button class="btn btnSmall btnGhost" data-rx="antiinflamatorio" type="button">Anti-inflamat√≥rio</button>
                      <button class="btn btnSmall btnGhost" data-rx="antibiotico" type="button">Antibi√≥tico</button>
                      <button class="btn btnSmall btnGhost" data-rx="livre" type="button">Livre</button>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <div class="field">
                        <label>Texto da receita</label>
                        <textarea id="docBody" placeholder="Escreva aqui... (ou escolha um modelo acima)"></textarea>
                      </div>
                    </div>
                  </div>
                </div>

                <div id="genericDocWrap" style="margin-top:12px; display:none;" class="panel">
                  <div class="panelHeader">
                    <strong>Conte√∫do do documento</strong>
                    <div class="mini mono">A4 ‚Ä¢ borda azul</div>
                  </div>
                  <div class="panelBody">
                    <div class="row">
                      <div class="field">
                        <label>Texto</label>
                        <textarea id="docBody2" placeholder="Escreva o conte√∫do do documento..."></textarea>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="infoBox" style="margin-top:12px;">
                  <h4>Sem duplicar impress√£o</h4>
                  <ul>
                    <li>O bot√£o ‚ÄúImprimir A4‚Äù abre uma janela √∫nica para impress√£o</li>
                    <li>Ele bloqueia clique repetido por alguns segundos</li>
                    <li>O documento √© montado em uma p√°gina A4 com borda</li>
                  </ul>
                </div>
              </div>

              <div class="panel" style="background:rgba(0,0,0,.14); border-radius:22px;">
                <div class="panelHeader">
                  <strong>Pr√©-visualiza√ß√£o (resumo)</strong>
                  <div class="mini" id="docPreviewMini">‚Äî</div>
                </div>
                <div class="panelBody">
                  <div class="infoBox">
                    <h4>Profissional</h4>
                    <ul id="proPreviewList"></ul>
                  </div>
                  <div class="infoBox" style="margin-top:12px;">
                    <h4>Paciente</h4>
                    <ul id="patPreviewList"></ul>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- ====== CONFIG VIEW ====== -->
        <section class="panel" id="view-config" style="display:none;">
          <div class="panelHeader">
            <strong>Config ‚Ä¢ senha ‚Ä¢ backup ‚Ä¢ manuten√ß√£o</strong>
            <div class="row">
              <button class="btn btnSmall btnDanger btnGhost" id="wipeBtn" type="button">üß® Zerar tudo</button>
            </div>
          </div>
          <div class="panelBody">
            <div class="split">
              <div class="panel" style="background:rgba(0,0,0,.14); border-radius:22px;">
                <div class="panelHeader"><strong>Senha</strong><div class="mini mono">local</div></div>
                <div class="panelBody">
                  <div class="row">
                    <div class="field">
                      <label>Senha atual</label>
                      <input id="oldPass" type="password" placeholder=""/>
                    </div>
                    <div class="field">
                      <label>Nova senha</label>
                      <input id="newPass" type="password" placeholder=""/>
                    </div>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button class="btn btnAccent" id="changePassBtn" type="button">Atualizar senha</button>
                    <span class="mini">Padr√£o inicial: <span class="mono">1234</span></span>
                  </div>
                </div>
              </div>

              <div class="panel" style="background:rgba(0,0,0,.14); border-radius:22px;">
                <div class="panelHeader"><strong>Backup</strong><div class="mini mono">JSON</div></div>
                <div class="panelBody">
                  <div class="infoBox">
                    <h4>Exportar / Importar</h4>
                    <ul>
                      <li><strong>Exportar</strong> baixa um arquivo JSON com agenda, pacientes, odontograma e config</li>
                      <li><strong>Importar</strong> restaura tudo em outro aparelho</li>
                      <li>Recomendado: exportar semanalmente</li>
                    </ul>
                  </div>
                  <div class="row" style="margin-top:12px;">
                    <button class="btn btnAccent" id="backupBtn2" type="button">‚¨áÔ∏è Exportar agora</button>
                    <label class="btn btnGhost">
                      <input id="restoreInput2" type="file" accept="application/json" style="display:none"/>
                      ‚¨ÜÔ∏è Importar agora
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="infoBox" style="margin-top:14px;">
              <h4>Roadmap (se voc√™ quiser evoluir)</h4>
              <ul>
                <li>Gerar PDF ‚Äúperfeito‚Äù via motor dedicado (sem depender do print)</li>
                <li>Odontograma com superf√≠cies + s√≠mbolos padr√£o</li>
                <li>Integra√ß√£o WhatsApp 1-toque em agendamentos</li>
                <li>IndexedDB para anexos (fotos/documentos) por paciente</li>
              </ul>
            </div>
          </div>
        </section>

      </main>
    </div>
  </section>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <strong id="modalTitle">‚Äî</strong>
        <button class="btn btnSmall btnGhost" id="modalCloseBtn" type="button">Fechar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

<script>
/* =========================
   BTX CLINIC ‚Ä¢ SINGLE FILE
   Offline storage: localStorage
   ========================= */

const LS_KEY = "btxClinic_v1";
const DEFAULTS = () => ({
  meta: { createdAt: Date.now(), version: "1.0" },
  auth: { pass: "1234", lastLoginAt: null },
  pro: {
    name: "Dr. Orlando Abreu Gomes da Silva",
    degrees: [
      "Graduado em Odontologia (2010)",
      "P√≥s-gradua√ß√£o em Cirurgia e Traumatologia Buco-Maxilo-Facial (2016)",
      "P√≥s-graduado em Sa√∫de Coletiva",
      "P√≥s-graduando em Patologia",
      "Graduando em Medicina",
      "Graduando em Engenharia da Computa√ß√£o e An√°lise de Sistemas"
    ],
    highlight: "Fundador de BTX Tech, startup de biotecnologia.",
    photoDataUrl: null,
    tag: "BTX Clinic ‚Ä¢ offline"
  },
  patients: [], // {id, name, phone, cpf, dob, address, notes, updatedAt, history:[{ts, text}], odonto:{toothId: state}}
  appointments: [], // {id, date:'YYYY-MM-DD', time:'HH:MM', patientId, patientName, phone, status, note, createdAt, updatedAt}
  ui: {
    selectedView: "agenda",
    agendaDate: new Date().toISOString().slice(0,10),
    lastRxTemplate: "analgesico",
    lastDocType: "receita",
    lastDocPatientId: null
  }
});

function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
function now(){ return Date.now(); }
function fmtDateBR(iso){
  if(!iso) return "‚Äî";
  const [y,m,d] = iso.split("-").map(Number);
  return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")}/${y}`;
}
function fmtTime(t){ return (t || "‚Äî"); }
function safeText(s){ return (s ?? "").toString(); }

let DB = loadDB();

function loadDB(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return DEFAULTS();
    const data = JSON.parse(raw);
    // merge with defaults (para upgrades)
    const def = DEFAULTS();
    return deepMerge(def, data);
  }catch(e){
    console.warn("Falha ao carregar DB:", e);
    return DEFAULTS();
  }
}
function saveDB(){
  localStorage.setItem(LS_KEY, JSON.stringify(DB));
}
function deepMerge(target, source){
  if(typeof source !== "object" || source === null) return target;
  for(const k of Object.keys(source)){
    const sv = source[k];
    const tv = target[k];
    if(Array.isArray(sv)){
      target[k] = sv; // arrays: substitui
    } else if(typeof sv === "object" && sv !== null){
      target[k] = deepMerge((tv && typeof tv==="object" && !Array.isArray(tv)) ? tv : {}, sv);
    } else {
      target[k] = sv;
    }
  }
  return target;
}

/* ===== Toast ===== */
const toastEl = document.getElementById("toast");
function toast(msg){
  const t = document.createElement("div");
  t.className = "t";
  t.textContent = msg;
  toastEl.appendChild(t);
  setTimeout(()=>{ t.style.opacity = "0"; t.style.transform = "translateY(6px)"; }, 2200);
  setTimeout(()=>{ t.remove(); }, 2900);
}

/* ===== Modal ===== */
const modalBack = document.getElementById("modalBack");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const modalFoot = document.getElementById("modalFoot");
document.getElementById("modalCloseBtn").onclick = ()=> closeModal();
modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });

function openModal(title, bodyNode, footNodes=[]){
  modalTitle.textContent = title;
  modalBody.innerHTML = "";
  modalBody.appendChild(bodyNode);
  modalFoot.innerHTML = "";
  footNodes.forEach(n=> modalFoot.appendChild(n));
  modalBack.style.display = "flex";
}
function closeModal(){ modalBack.style.display = "none"; }

/* ===== Landing photo upload ===== */
const landingPhoto = document.getElementById("landingPhoto");
const sidePhoto = document.getElementById("sidePhoto");
const photoInput = document.getElementById("photoInput");
const removePhotoBtn = document.getElementById("removePhotoBtn");

photoInput.addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const dataUrl = await fileToDataUrl(f);
  DB.pro.photoDataUrl = dataUrl;
  saveDB();
  renderPhotos();
  toast("Foto salva no dispositivo ‚úÖ");
});
removePhotoBtn.onclick = ()=>{
  DB.pro.photoDataUrl = null;
  saveDB();
  renderPhotos();
  toast("Foto removida.");
};

function fileToDataUrl(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function renderPhotos(){
  // landing
  landingPhoto.innerHTML = "";
  if(DB.pro.photoDataUrl){
    const img = new Image();
    img.src = DB.pro.photoDataUrl;
    landingPhoto.appendChild(img);
  } else {
    landingPhoto.innerHTML = `<span class="mono muted">FOTO<br/>PROFISSIONAL</span>`;
  }
  // sidebar
  sidePhoto.innerHTML = "";
  if(DB.pro.photoDataUrl){
    const img2 = new Image();
    img2.src = DB.pro.photoDataUrl;
    sidePhoto.appendChild(img2);
  } else {
    sidePhoto.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(232,240,255,.55);font-family:var(--mono);font-size:11px;">SEM FOTO</div>`;
  }
  document.getElementById("proNameSide").textContent = DB.pro.name;
  document.getElementById("proTagSide").textContent = DB.pro.tag || "BTX Clinic ‚Ä¢ offline";
}

/* ===== Login ===== */
const loginBtn = document.getElementById("loginBtn");
const loginPass = document.getElementById("loginPass");
const landing = document.getElementById("landing");
const app = document.getElementById("app");
const loginDock = document.getElementById("loginDock");

loginBtn.onclick = ()=> doLogin();
loginPass.addEventListener("keydown", (e)=>{ if(e.key === "Enter") doLogin(); });

function doLogin(){
  const pass = loginPass.value.trim();
  if(pass !== (DB.auth.pass || "1234")){
    toast("Senha incorreta ‚ùå");
    loginPass.focus();
    return;
  }
  DB.auth.lastLoginAt = now();
  saveDB();
  landing.style.display = "none";
  loginDock.style.display = "none";
  app.style.display = "block";
  toast("Bem-vindo ao BTX Clinic ‚úÖ");
  initApp();
}

/* ===== Logout ===== */
document.getElementById("logoutBtn").onclick = ()=>{
  app.style.display = "none";
  landing.style.display = "grid";
  loginDock.style.display = "block";
  loginPass.value = "";
  toast("Saiu do sistema.");
};

/* ===== Navigation ===== */
const nav = document.getElementById("nav");
nav.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-view]");
  if(!btn) return;
  setView(btn.dataset.view);
});

function setView(view){
  DB.ui.selectedView = view;
  saveDB();
  [...nav.querySelectorAll("button")].forEach(b=> b.classList.toggle("active", b.dataset.view===view));
  ["agenda","patients","chart","docs","config"].forEach(v=>{
    document.getElementById("view-"+v).style.display = (v===view) ? "block":"none";
  });
  const titles = {agenda:"Agenda", patients:"Pacientes", chart:"Odontograma", docs:"Documentos", config:"Config"};
  document.getElementById("viewTitle").textContent = titles[view] || "BTX Clinic";
  // refresh relevant
  if(view==="agenda") renderAgenda();
  if(view==="patients") renderPatients();
  if(view==="chart") renderOdonto();
  if(view==="docs") renderDocs();
}

/* ===== Quick buttons ===== */
document.getElementById("quickTodayBtn").onclick = ()=>{
  DB.ui.agendaDate = new Date().toISOString().slice(0,10);
  saveDB();
  document.getElementById("agendaDate").value = DB.ui.agendaDate;
  renderAgenda();
  toast("Agenda: hoje üìÖ");
};
document.getElementById("quickNewApptBtn").onclick = ()=> openApptModal();

/* ====== Agenda ====== */
const agendaDateInput = document.getElementById("agendaDate");
const agendaSearch = document.getElementById("agendaSearch");
const agendaFilterStatus = document.getElementById("agendaFilterStatus");
document.getElementById("prevDayBtn").onclick = ()=> shiftDay(-1);
document.getElementById("nextDayBtn").onclick = ()=> shiftDay(1);
document.getElementById("addApptBtn").onclick = ()=> openApptModal();
agendaDateInput.onchange = ()=>{
  DB.ui.agendaDate = agendaDateInput.value;
  saveDB();
  renderAgenda();
};
agendaSearch.oninput = ()=> renderAgenda();
agendaFilterStatus.onchange = ()=> renderAgenda();

function shiftDay(delta){
  const d = new Date(DB.ui.agendaDate+"T00:00:00");
  d.setDate(d.getDate() + delta);
  DB.ui.agendaDate = d.toISOString().slice(0,10);
  saveDB();
  agendaDateInput.value = DB.ui.agendaDate;
  renderAgenda();
}

function weekRange(iso){
  const d = new Date(iso+"T00:00:00");
  const day = d.getDay(); // 0 sunday
  const diffToMon = (day === 0 ? -6 : 1 - day);
  const mon = new Date(d); mon.setDate(d.getDate()+diffToMon);
  const sun = new Date(mon); sun.setDate(mon.getDate()+6);
  return [mon.toISOString().slice(0,10), sun.toISOString().slice(0,10)];
}

function renderAgenda(){
  const iso = DB.ui.agendaDate;
  agendaDateInput.value = iso;
  document.getElementById("agendaDateTag").textContent = `üìÖ ${fmtDateBR(iso)}`;

  // counts
  const dayItems = DB.appointments.filter(a => a.date === iso);
  const [mon, sun] = weekRange(iso);
  const weekItems = DB.appointments.filter(a => a.date >= mon && a.date <= sun);

  document.getElementById("countDayTag").textContent = `${dayItems.length} pacientes no dia`;
  document.getElementById("countWeekTag").textContent = `${weekItems.length} na semana`;
  document.getElementById("navAgendaCount").textContent = `${dayItems.length} hoje`;

  // summary
  const stats = {confirmado:0, pendente:0, faltou:0, concluido:0};
  dayItems.forEach(a => stats[a.status] = (stats[a.status]||0)+1);
  document.getElementById("daySummaryMini").textContent =
    `conf ${stats.confirmado} ‚Ä¢ pend ${stats.pendente} ‚Ä¢ concl ${stats.concluido} ‚Ä¢ falt ${stats.faltou}`;

  // filter/search
  const q = agendaSearch.value.trim().toLowerCase();
  const st = agendaFilterStatus.value;

  let list = dayItems.slice().sort((a,b)=> (a.time||"").localeCompare(b.time||""));
  if(st) list = list.filter(a=> a.status === st);
  if(q){
    list = list.filter(a=>{
      const hay = `${a.patientName||""} ${a.phone||""} ${a.note||""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  const tbody = document.querySelector("#agendaTable tbody");
  tbody.innerHTML = "";
  if(list.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">Nenhum agendamento para este filtro.</td>`;
    tbody.appendChild(tr);
    return;
  }

  list.forEach(a=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${fmtTime(a.time)}</td>
      <td>
        <div style="font-weight:900;">${safeText(a.patientName) || "<span class='muted'>Sem nome</span>"}</div>
        <div class="muted" style="font-size:12px;">
          ${a.phone ? safeText(a.phone) : ""} ${a.note ? "‚Ä¢ "+safeText(a.note) : ""}
        </div>
      </td>
      <td>${statusTag(a.status)}</td>
      <td>
        <div class="row" style="gap:8px;">
          <button class="btn btnSmall btnGhost" data-act="edit" data-id="${a.id}">Editar</button>
          <button class="btn btnSmall btnGhost" data-act="openPatient" data-id="${a.id}">Ficha</button>
          <button class="btn btnSmall btnDanger btnGhost" data-act="del" data-id="${a.id}">Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.onclick = (e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const id = b.dataset.id;
    const act = b.dataset.act;
    if(act==="edit"){
      const ap = DB.appointments.find(x=>x.id===id);
      if(ap) openApptModal(ap);
    }
    if(act==="del"){
      if(confirm("Excluir este agendamento?")){
        DB.appointments = DB.appointments.filter(x=>x.id!==id);
        saveDB(); renderAgenda(); toast("Agendamento exclu√≠do.");
      }
    }
    if(act==="openPatient"){
      const ap = DB.appointments.find(x=>x.id===id);
      if(!ap) return;
      const p = ensurePatientFromAppt(ap);
      DB.ui.selectedView = "patients";
      saveDB();
      setView("patients");
      selectPatient(p.id);
      toast("Ficha aberta.");
    }
  };
}

function statusTag(st){
  const map = {
    confirmado: `<span class="tag ok">confirmado</span>`,
    pendente: `<span class="tag warn">pendente</span>`,
    faltou: `<span class="tag bad">faltou</span>`,
    concluido: `<span class="tag ok">conclu√≠do</span>`
  };
  return map[st] || `<span class="tag">‚Äî</span>`;
}

function openApptModal(appt=null){
  const body = document.createElement("div");
  const id = appt?.id || uid("appt");
  const isEdit = !!appt;

  body.innerHTML = `
    <div class="row">
      <div class="field">
        <label>Data</label>
        <input id="mDate" type="date" value="${appt?.date || DB.ui.agendaDate}"/>
      </div>
      <div class="field" style="max-width:200px;">
        <label>Hora</label>
        <input id="mTime" type="time" value="${appt?.time || "08:00"}"/>
      </div>
      <div class="field">
        <label>Paciente (nome)</label>
        <input id="mName" type="text" value="${safeText(appt?.patientName)}" placeholder="Nome do paciente"/>
      </div>
    </div>

    <div class="row">
      <div class="field" style="max-width:260px;">
        <label>Telefone</label>
        <input id="mPhone" type="text" value="${safeText(appt?.phone)}" placeholder="(91) ..."/>
      </div>
      <div class="field" style="max-width:220px;">
        <label>Status</label>
        <select id="mStatus">
          <option value="pendente">Pendente</option>
          <option value="confirmado">Confirmado</option>
          <option value="concluido">Conclu√≠do</option>
          <option value="faltou">Faltou</option>
        </select>
      </div>
      <div class="field">
        <label>Observa√ß√£o</label>
        <input id="mNote" type="text" value="${safeText(appt?.note)}" placeholder="Retorno, procedimento, etc."/>
      </div>
    </div>

    <div class="infoBox" style="margin-top:12px;">
      <h4>Dica</h4>
      <ul>
        <li>Quando voc√™ cria agendamento com nome, o sistema consegue linkar/gerar paciente automaticamente</li>
        <li>Depois voc√™ abre a ficha e vai alimentando a mem√≥ria cl√≠nica</li>
      </ul>
    </div>
  `;

  const btnSave = document.createElement("button");
  btnSave.className = "btn btnAccent";
  btnSave.textContent = isEdit ? "Salvar altera√ß√µes" : "Criar agendamento";

  const btnCancel = document.createElement("button");
  btnCancel.className = "btn btnGhost";
  btnCancel.textContent = "Cancelar";

  btnCancel.onclick = ()=> closeModal();
  btnSave.onclick = ()=>{
    const date = body.querySelector("#mDate").value;
    const time = body.querySelector("#mTime").value;
    const name = body.querySelector("#mName").value.trim();
    const phone = body.querySelector("#mPhone").value.trim();
    const status = body.querySelector("#mStatus").value;
    const note = body.querySelector("#mNote").value.trim();

    if(!date || !time){
      toast("Informe data e hora.");
      return;
    }
    if(!name){
      toast("Informe o nome do paciente.");
      return;
    }

    const base = {
      id,
      date, time,
      patientName: name,
      phone,
      status,
      note,
      updatedAt: now()
    };

    if(isEdit){
      const idx = DB.appointments.findIndex(x=>x.id===id);
      if(idx>=0){
        DB.appointments[idx] = {...DB.appointments[idx], ...base};
      }
      toast("Agendamento atualizado ‚úÖ");
    } else {
      DB.appointments.push({...base, createdAt: now(), patientId: null});
      toast("Agendamento criado ‚úÖ");
    }

    saveDB();
    DB.ui.agendaDate = date;
    saveDB();
    closeModal();
    renderAgenda();
  };

  // set selected status
  setTimeout(()=>{
    body.querySelector("#mStatus").value = appt?.status || "pendente";
  },0);

  openModal(isEdit ? "Editar agendamento" : "Novo agendamento", body, [btnCancel, btnSave]);
}

function ensurePatientFromAppt(ap){
  // try by patientId
  if(ap.patientId){
    const p = DB.patients.find(x=>x.id===ap.patientId);
    if(p) return p;
  }
  // try by name+phone
  const name = (ap.patientName||"").trim().toLowerCase();
  const phone = (ap.phone||"").trim();
  let p = DB.patients.find(x=> x.name.trim().toLowerCase()===name && (phone ? x.phone.trim()===phone : true));
  if(!p){
    p = {
      id: uid("pat"),
      name: ap.patientName || "Sem nome",
      phone: ap.phone || "",
      cpf: "",
      dob: "",
      address: "",
      notes: "",
      updatedAt: now(),
      history: [{ts: now(), text: `Criado automaticamente a partir do agendamento em ${fmtDateBR(ap.date)}.`}],
      odonto: {}
    };
    DB.patients.push(p);
    toast("Paciente criado automaticamente a partir do agendamento ‚úÖ");
  }
  // link appt
  ap.patientId = p.id;
  saveDB();
  return p;
}

/* ====== Patients ====== */
document.getElementById("addPatientBtn").onclick = ()=> createNewPatient();
document.getElementById("patientSearch").oninput = ()=> renderPatients();
document.getElementById("patientSort").onchange = ()=> renderPatients();
document.getElementById("savePatientBtn").onclick = ()=> saveSelectedPatient();
document.getElementById("openOdontoFromPatientBtn").onclick = ()=>{
  if(!selectedPatientId){ toast("Selecione um paciente."); return; }
  setView("chart");
};

let selectedPatientId = null;

function createNewPatient(){
  const p = {
    id: uid("pat"),
    name: "Novo paciente",
    phone: "",
    cpf: "",
    dob: "",
    address: "",
    notes: "",
    updatedAt: now(),
    history: [{ts: now(), text: "Paciente criado manualmente."}],
    odonto: {}
  };
  DB.patients.push(p);
  saveDB();
  renderPatients();
  selectPatient(p.id);
  toast("Paciente criado.");
}

function renderPatients(){
  document.getElementById("navPatientsCount").textContent = `${DB.patients.length}`;
  const q = document.getElementById("patientSearch").value.trim().toLowerCase();
  const sort = document.getElementById("patientSort").value;

  let list = DB.patients.slice();
  if(q){
    list = list.filter(p=>{
      const hay = `${p.name||""} ${p.phone||""} ${p.notes||""}`.toLowerCase();
      return hay.includes(q);
    });
  }
  if(sort==="name") list.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  if(sort==="recent") list.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));

  const tbody = document.querySelector("#patientsTable tbody");
  tbody.innerHTML = "";

  if(list.length===0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">Nenhum paciente encontrado.</td>`;
    tbody.appendChild(tr);
  } else {
    list.forEach(p=>{
      const tr = document.createElement("tr");
      const date = p.updatedAt ? new Date(p.updatedAt).toLocaleDateString("pt-BR") : "‚Äî";
      tr.innerHTML = `
        <td>
          <div style="font-weight:900;">${safeText(p.name)}</div>
          <div class="muted" style="font-size:12px;">${(p.notes||"").slice(0,60)}${(p.notes||"").length>60?"‚Ä¶":""}</div>
        </td>
        <td class="mono">${safeText(p.phone) || "‚Äî"}</td>
        <td class="mono">${date}</td>
        <td>
          <div class="row" style="gap:8px;">
            <button class="btn btnSmall btnGhost" data-act="select" data-id="${p.id}">Abrir</button>
            <button class="btn btnSmall btnGhost" data-act="doc" data-id="${p.id}">Docs</button>
            <button class="btn btnSmall btnDanger btnGhost" data-act="del" data-id="${p.id}">Excluir</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  tbody.onclick = (e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const id = b.dataset.id;
    const act = b.dataset.act;

    if(act==="select"){
      selectPatient(id);
    }
    if(act==="doc"){
      selectPatient(id);
      setView("docs");
    }
    if(act==="del"){
      if(confirm("Excluir paciente e seus dados?")){
        DB.patients = DB.patients.filter(x=>x.id!==id);
        // unlink in appointments
        DB.appointments.forEach(a=>{ if(a.patientId===id) a.patientId=null; });
        saveDB();
        if(selectedPatientId===id) selectedPatientId=null;
        renderPatients();
        toast("Paciente exclu√≠do.");
      }
    }
  };

  // keep selection valid
  if(selectedPatientId && !DB.patients.find(p=>p.id===selectedPatientId)){
    selectedPatientId = null;
  }
  if(selectedPatientId){
    fillPatientForm(DB.patients.find(p=>p.id===selectedPatientId));
  } else {
    clearPatientForm();
  }
}

function selectPatient(id){
  const p = DB.patients.find(x=>x.id===id);
  if(!p){ toast("Paciente n√£o encontrado."); return; }
  selectedPatientId = id;
  fillPatientForm(p);
  toast(`Selecionado: ${p.name}`);
}

function fillPatientForm(p){
  document.getElementById("selectedPatientTag").textContent = p?.name ? p.name : "Nenhum";
  document.getElementById("pName").value = p.name || "";
  document.getElementById("pPhone").value = p.phone || "";
  document.getElementById("pCpf").value = p.cpf || "";
  document.getElementById("pDob").value = p.dob || "";
  document.getElementById("pAddress").value = p.address || "";
  document.getElementById("pNotes").value = p.notes || "";

  const ul = document.getElementById("pHistory");
  ul.innerHTML = "";
  const hist = p.history || [];
  document.getElementById("pHistoryEmpty").style.display = hist.length ? "none":"block";
  hist.slice().sort((a,b)=> (b.ts||0)-(a.ts||0)).slice(0,10).forEach(h=>{
    const li = document.createElement("li");
    const d = new Date(h.ts).toLocaleString("pt-BR");
    li.innerHTML = `<span class="mono">${d}</span> ‚Ä¢ ${safeText(h.text)}`;
    ul.appendChild(li);
  });
}

function clearPatientForm(){
  document.getElementById("selectedPatientTag").textContent = "Nenhum";
  ["pName","pPhone","pCpf","pDob","pAddress","pNotes"].forEach(id=> document.getElementById(id).value="");
  document.getElementById("pHistory").innerHTML = "";
  document.getElementById("pHistoryEmpty").style.display = "block";
}

function saveSelectedPatient(){
  if(!selectedPatientId){
    toast("Selecione um paciente.");
    return;
  }
  const p = DB.patients.find(x=>x.id===selectedPatientId);
  if(!p){ toast("Paciente n√£o encontrado."); return; }

  const name = document.getElementById("pName").value.trim();
  if(!name){ toast("Nome √© obrigat√≥rio."); return; }

  p.name = name;
  p.phone = document.getElementById("pPhone").value.trim();
  p.cpf = document.getElementById("pCpf").value.trim();
  p.dob = document.getElementById("pDob").value;
  p.address = document.getElementById("pAddress").value.trim();
  p.notes = document.getElementById("pNotes").value.trim();
  p.updatedAt = now();
  p.history = p.history || [];
  p.history.push({ts: now(), text: "Ficha atualizada."});

  // update linked appointments names/phones
  DB.appointments.forEach(a=>{
    if(a.patientId===p.id){
      a.patientName = p.name;
      if(p.phone) a.phone = p.phone;
      a.updatedAt = now();
    }
  });

  saveDB();
  renderPatients();
  renderAgenda();
  toast("Ficha salva ‚úÖ");
}

/* ====== Odontogram ====== */
const upperGrid = document.getElementById("upperGrid");
const lowerGrid = document.getElementById("lowerGrid");
document.getElementById("odontoResetBtn").onclick = ()=> {
  const p = currentOdontoPatient();
  if(!p){ toast("Selecione um paciente na aba Pacientes."); return; }
  if(confirm("Limpar odontograma deste paciente?")){
    p.odonto = {};
    p.updatedAt = now();
    p.history = p.history || [];
    p.history.push({ts: now(), text:"Odontograma limpo."});
    saveDB();
    renderOdonto();
    toast("Odontograma limpo.");
  }
};
document.getElementById("odontoSaveBtn").onclick = ()=>{
  const p = currentOdontoPatient();
  if(!p){ toast("Selecione um paciente na aba Pacientes."); return; }
  p.updatedAt = now();
  p.history = p.history || [];
  p.history.push({ts: now(), text:"Odontograma atualizado."});
  saveDB();
  toast("Odontograma salvo ‚úÖ");
  renderPatients();
};

function currentOdontoPatient(){
  if(selectedPatientId){
    return DB.patients.find(x=>x.id===selectedPatientId);
  }
  // fallback: lastDocPatientId
  if(DB.ui.lastDocPatientId){
    const p = DB.patients.find(x=>x.id===DB.ui.lastDocPatientId);
    if(p) return p;
  }
  return null;
}

const toothStates = ["normal","carie","restaurado","canal","ausente"];
const stateLabel = {
  normal:"normal",
  carie:"c√°rie",
  restaurado:"restaurado",
  canal:"canal",
  ausente:"ausente"
};

function renderOdonto(){
  const p = currentOdontoPatient();
  document.getElementById("odontoPatientTag").textContent = `Paciente: ${p ? p.name : "‚Äî"}`;
  upperGrid.innerHTML = "";
  lowerGrid.innerHTML = "";
  if(!p){
    const hint = document.createElement("div");
    hint.className = "muted";
    hint.textContent = "Selecione um paciente na aba Pacientes para editar o odontograma.";
    upperGrid.appendChild(hint);
    return;
  }
  p.odonto = p.odonto || {};

  // Upper: 18..11 and 21..28
  const upper = [18,17,16,15,14,13,12,11, 21,22,23,24,25,26,27,28];
  const lower = [48,47,46,45,44,43,42,41, 31,32,33,34,35,36,37,38];

  buildTeethGrid(upperGrid, upper, p);
  buildTeethGrid(lowerGrid, lower, p);
}

function buildTeethGrid(container, teeth, p){
  teeth.forEach(id=>{
    const st = p.odonto[id] || "normal";
    const el = document.createElement("div");
    el.className = "tooth";
    el.dataset.tooth = id;
    el.dataset.state = st;
    el.innerHTML = `
      <div class="id">${id}</div>
      <div class="state">${stateLabel[st] || st}</div>
    `;
    el.onclick = ()=>{
      const curr = p.odonto[id] || "normal";
      const next = toothStates[(toothStates.indexOf(curr)+1) % toothStates.length];
      p.odonto[id] = next;
      saveDB();
      el.dataset.state = next;
      el.querySelector(".state").textContent = stateLabel[next] || next;
    };
    container.appendChild(el);
  });
}

/* ====== Docs ====== */
const docType = document.getElementById("docType");
const docPatient = document.getElementById("docPatient");
const docDate = document.getElementById("docDate");
const docBody = document.getElementById("docBody");
const docBody2 = document.getElementById("docBody2");
const rxQuickWrap = document.getElementById("rxQuickWrap");
const genericDocWrap = document.getElementById("genericDocWrap");
const docPrintBtn = document.getElementById("docPrintBtn");
document.getElementById("docClearBtn").onclick = ()=>{
  docBody.value = "";
  docBody2.value = "";
  toast("Documento limpo.");
  updateDocPreview();
};

docType.onchange = ()=>{
  DB.ui.lastDocType = docType.value;
  saveDB();
  renderDocs();
};
docPatient.onchange = ()=>{
  DB.ui.lastDocPatientId = docPatient.value || null;
  saveDB();
  updateDocPreview();
};
docDate.onchange = ()=> updateDocPreview();
docBody.oninput = ()=> updateDocPreview();
docBody2.oninput = ()=> updateDocPreview();

function renderDocs(){
  // populate patients dropdown
  docPatient.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "‚Äî selecione ‚Äî";
  docPatient.appendChild(opt0);

  DB.patients.slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"")).forEach(p=>{
    const o = document.createElement("option");
    o.value = p.id;
    o.textContent = p.name + (p.phone ? ` ‚Ä¢ ${p.phone}`:"");
    docPatient.appendChild(o);
  });

  docDate.value = new Date().toISOString().slice(0,10);

  docType.value = DB.ui.lastDocType || "receita";
  if(DB.ui.lastDocPatientId && DB.patients.find(p=>p.id===DB.ui.lastDocPatientId)){
    docPatient.value = DB.ui.lastDocPatientId;
  } else if(selectedPatientId){
    docPatient.value = selectedPatientId;
    DB.ui.lastDocPatientId = selectedPatientId;
    saveDB();
  } else {
    docPatient.value = "";
  }

  const type = docType.value;
  const isRx = type === "receita";
  rxQuickWrap.style.display = isRx ? "block":"none";
  genericDocWrap.style.display = isRx ? "none":"block";

  // move content binding
  if(!isRx){
    // keep sync: if docBody has something, mirror to docBody2 (first time)
    if(!docBody2.value && docBody.value) docBody2.value = docBody.value;
  }

  // pro preview
  const pro = DB.pro;
  const proList = document.getElementById("proPreviewList");
  proList.innerHTML = "";
  const li1 = document.createElement("li");
  li1.innerHTML = `<strong>${safeText(pro.name)}</strong>`;
  proList.appendChild(li1);
  const li2 = document.createElement("li");
  li2.textContent = (pro.highlight || "").trim();
  proList.appendChild(li2);

  updateDocPreview();
}

/* Rx templates */
const rxTemplates = {
  analgesico:
`1) Dipirona 500 mg
Tomar 1 comprimido a cada 6 horas se dor por 3 dias.

2) Paracetamol 750 mg
Tomar 1 comprimido a cada 8 horas se dor por 3 dias.

Orienta√ß√µes: evitar automedica√ß√£o adicional. Retornar se piora.`,
  antiinflamatorio:
`1) Ibuprofeno 600 mg
Tomar 1 comprimido a cada 8 horas por 3 dias, ap√≥s alimenta√ß√£o.

OU (conforme avalia√ß√£o cl√≠nica)
Naproxeno 500 mg
Tomar 1 comprimido a cada 12 horas por 3 dias.

Orienta√ß√µes: cautela em gastrite/√∫lcera, doen√ßa renal, anticoagulantes.`,
  antibiotico:
`1) Amoxicilina 500 mg
Tomar 1 c√°psula a cada 8 horas por 7 dias.

Alergia a penicilina (exemplo):
Clindamicina 300 mg
Tomar 1 c√°psula a cada 8 horas por 7 dias.

Orienta√ß√µes: manter hor√°rios e completar o ciclo.`,
  livre: `Escreva a prescri√ß√£o aqui...`
};

document.querySelectorAll('[data-rx]').forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const key = btn.dataset.rx;
    DB.ui.lastRxTemplate = key;
    saveDB();
    docBody.value = rxTemplates[key] || "";
    toast(`Modelo: ${key}`);
    updateDocPreview();
  });
});

function getSelectedPatient(){
  const id = docPatient.value || selectedPatientId || null;
  if(!id) return null;
  return DB.patients.find(p=>p.id===id) || null;
}

function updateDocPreview(){
  const p = getSelectedPatient();
  const type = docType.value;
  const date = docDate.value || new Date().toISOString().slice(0,10);

  document.getElementById("docPreviewMini").textContent = `${type.toUpperCase()} ‚Ä¢ ${fmtDateBR(date)}`;

  const patList = document.getElementById("patPreviewList");
  patList.innerHTML = "";
  if(!p){
    patList.innerHTML = `<li class="muted">Selecione um paciente para completar o documento.</li>`;
  } else {
    const liA = document.createElement("li");
    liA.innerHTML = `<strong>${safeText(p.name)}</strong>`;
    patList.appendChild(liA);
    const liB = document.createElement("li");
    liB.textContent = p.phone ? `Telefone: ${p.phone}` : "Telefone: ‚Äî";
    patList.appendChild(liB);
    const liC = document.createElement("li");
    liC.textContent = p.cpf ? `CPF: ${p.cpf}` : "CPF: ‚Äî";
    patList.appendChild(liC);
  }
}

/* Print A4 with no duplicates */
let printingLock = false;
docPrintBtn.onclick = ()=>{
  if(printingLock){ toast("Aguarde‚Ä¶ evitando duplica√ß√£o üõ°Ô∏è"); return; }
  printingLock = true;
  docPrintBtn.disabled = true;

  try{
    const type = docType.value;
    const p = getSelectedPatient();
    if(!p){ toast("Selecione um paciente."); unlockPrintSoon(); return; }

    const date = docDate.value || new Date().toISOString().slice(0,10);
    const pro = DB.pro;

    const titleMap = {
      receita: "Receitu√°rio",
      atestado: "Atestado",
      orcamento: "Or√ßamento"
    };
    const docTitle = titleMap[type] || "Documento";

    const bodyText = (type==="receita") ? docBody.value : docBody2.value;
    if(!bodyText.trim()){
      toast("Escreva o conte√∫do do documento.");
      unlockPrintSoon();
      return;
    }

    // Build printable HTML
    const printable = buildPrintHTML({
      pro, patient:p, type, docTitle, date, bodyText
    });

    // Open a single print window
    const w = window.open("", "BTX_PRINT_WINDOW");
    if(!w){ toast("Bloqueio de pop-up: permita para imprimir."); unlockPrintSoon(); return; }
    w.document.open();
    w.document.write(printable);
    w.document.close();

    // Print after load
    w.onload = ()=>{
      try{ w.focus(); w.print(); }catch(e){}
      unlockPrintSoon(1200);
    };

  }catch(err){
    console.error(err);
    toast("Erro ao preparar impress√£o.");
    unlockPrintSoon();
  }
};

function unlockPrintSoon(ms=1000){
  setTimeout(()=>{
    printingLock = false;
    docPrintBtn.disabled = false;
  }, ms);
}

function buildPrintHTML({pro, patient, type, docTitle, date, bodyText}){
  const proMeta = [
    pro.name,
    ...(pro.degrees || []),
    pro.highlight || ""
  ].filter(Boolean).join(" ‚Ä¢ ");

  const patMeta = [
    `Paciente: ${patient.name}`,
    patient.phone ? `Telefone: ${patient.phone}` : "",
    patient.cpf ? `CPF: ${patient.cpf}` : "",
    patient.dob ? `Nascimento: ${fmtDateBR(patient.dob)}` : ""
  ].filter(Boolean).join(" ‚Ä¢ ");

  const footerLeft = `${pro.name} ‚Ä¢ ${pro.highlight || "BTX Tech"}`;
  const footerRight = `Emitido em ${fmtDateBR(date)} ‚Ä¢ BTX Clinic`;

  // Basic print CSS inline
  return `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>${escapeHtml(docTitle)}</title>
<style>
  @page { size: A4; margin: 0; }
  body{
    margin:0;
    background:#fff;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  .docA4{
    width: 210mm;
    min-height: 297mm;
    margin: 0 auto;
    padding: 14mm 14mm;
    background:#ffffff;
    color:#0b0f14;
    border-radius: 10mm;
    border: 1.4mm solid #1f6fff;
    box-sizing:border-box;
    position:relative;
  }
  .docTop{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10mm;
    padding-bottom: 6mm;
    border-bottom: .4mm solid rgba(11,15,20,.15);
    margin-bottom: 6mm;
  }
  .docBrand{display:flex; flex-direction:column; gap:2mm;}
  .docBrand h1{margin:0; font-size: 16pt; letter-spacing:.3pt;}
  .docMeta{font-size:10pt; color: rgba(11,15,20,.75); line-height:1.35;}
  .docTitle{font-size: 13pt; font-weight: 800; margin: 0; text-align:right;}
  .docSection{
    margin-top: 4mm;
    font-size: 11pt;
    line-height: 1.45;
    white-space: pre-wrap;
  }
  .docFooter{
    position:absolute;
    left:14mm; right:14mm; bottom:12mm;
    border-top: .4mm solid rgba(11,15,20,.15);
    padding-top: 4mm;
    font-size: 9pt;
    color: rgba(11,15,20,.72);
    display:flex;
    justify-content:space-between;
    gap:10mm;
  }
  .docNoBreak{page-break-inside: avoid; break-inside: avoid;}
</style>
</head>
<body>
  <div class="docA4 docNoBreak">
    <div class="docTop docNoBreak">
      <div class="docBrand">
        <h1>${escapeHtml(pro.name)}</h1>
        <div class="docMeta">${escapeHtml(proMeta)}</div>
        <div class="docMeta" style="margin-top:2mm;">${escapeHtml(patMeta)}</div>
      </div>
      <div>
        <p class="docTitle">${escapeHtml(docTitle)}</p>
        <div class="docMeta" style="text-align:right;">Data: ${escapeHtml(fmtDateBR(date))}</div>
      </div>
    </div>

    <div class="docSection docNoBreak">${escapeHtml(bodyText)}</div>

    <div class="docFooter docNoBreak">
      <div>${escapeHtml(footerLeft)}</div>
      <div>${escapeHtml(footerRight)}</div>
    </div>
  </div>
</body>
</html>
`;
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== Backup / Restore ===== */
document.getElementById("backupBtn").onclick = exportBackup;
document.getElementById("backupBtn2").onclick = exportBackup;
document.getElementById("restoreInput").addEventListener("change", importBackup);
document.getElementById("restoreInput2").addEventListener("change", importBackup);

function exportBackup(){
  const blob = new Blob([JSON.stringify(DB,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  const stamp = new Date().toISOString().slice(0,10);
  a.href = URL.createObjectURL(blob);
  a.download = `BTX_Clinic_backup_${stamp}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  toast("Backup exportado ‚¨áÔ∏è");
}

async function importBackup(e){
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);
    DB = deepMerge(DEFAULTS(), obj);
    saveDB();
    renderAll();
    toast("Backup importado ‚úÖ");
  }catch(err){
    console.error(err);
    toast("Falha ao importar. Arquivo inv√°lido.");
  }finally{
    e.target.value = "";
  }
}

/* ===== Config: Change password, wipe ===== */
document.getElementById("changePassBtn").onclick = ()=>{
  const oldP = document.getElementById("oldPass").value.trim();
  const newP = document.getElementById("newPass").value.trim();
  if(oldP !== (DB.auth.pass || "1234")){
    toast("Senha atual incorreta.");
    return;
  }
  if(newP.length < 4){
    toast("Nova senha deve ter pelo menos 4 caracteres.");
    return;
  }
  DB.auth.pass = newP;
  saveDB();
  document.getElementById("oldPass").value = "";
  document.getElementById("newPass").value = "";
  toast("Senha atualizada ‚úÖ");
};

document.getElementById("wipeBtn").onclick = ()=>{
  if(confirm("Zerar tudo? Isso apaga agenda, pacientes e configura√ß√µes.")){
    localStorage.removeItem(LS_KEY);
    DB = DEFAULTS();
    saveDB();
    toast("Dados zerados.");
    // volta para landing
    app.style.display = "none";
    landing.style.display = "grid";
    loginDock.style.display = "block";
    loginPass.value = "";
    renderPhotos();
  }
};

/* ===== App init ===== */
function initApp(){
  renderAll();
  setView(DB.ui.selectedView || "agenda");
}

function renderAll(){
  renderPhotos();
  renderAgenda();
  renderPatients();
  renderOdonto();
  renderDocs();
}

/* ===== Start state ===== */
(function boot(){
  renderPhotos();
  // if you want auto-login on same device, you could check DB.auth.lastLoginAt etc.
  // Keeping manual login for safety.
  DB.ui.agendaDate = DB.ui.agendaDate || new Date().toISOString().slice(0,10);
  saveDB();
})();
</script>

</body>
</html>
