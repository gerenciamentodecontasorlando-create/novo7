<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>BTX Dental ‚Ä¢ Consult√≥rio</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg1:#0a0b10; --bg2:#0e1630;
      --glass:rgba(255,255,255,.10);
      --card:#ffffff; --card2:rgba(255,255,255,.94);
      --ink:#0f172a; --muted:rgba(15,23,42,.62);
      --line:rgba(15,23,42,.10);
      --shadow:0 18px 40px rgba(0,0,0,.20);
      --shadow2:0 10px 25px rgba(0,0,0,.14);
      --r:26px; --r2:18px;

      --sky:#56B6FF; --sky2:#2F8CFF;
      --mint:#7CF0C8; --pink:#FF7BB0;
      --amber:#FFD27A; --violet:#B692FF;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); min-height:100vh; color:#fff;
      background:
        radial-gradient(900px 540px at 20% 20%, rgba(86,182,255,.22), transparent 60%),
        radial-gradient(800px 520px at 80% 30%, rgba(255,123,176,.18), transparent 55%),
        radial-gradient(900px 520px at 50% 90%, rgba(124,240,200,.14), transparent 55%),
        linear-gradient(120deg, var(--bg1), var(--bg2) 55%, #070811);
      padding:22px;
      display:flex; align-items:center; justify-content:center;
    }

    .shell{
      width:min(1240px, 100%);
      background: var(--glass);
      border:1px solid rgba(255,255,255,.16);
      border-radius:34px;
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(14px);
    }

    .app{ display:grid; grid-template-columns: 92px 1fr; gap:14px; }

    /* Sidebar */
    .sidebar{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:26px;
      padding:14px 12px;
      display:flex; flex-direction:column; align-items:center; gap:12px;
      overflow:hidden;
    }
    .brand{
      width:46px; height:46px; border-radius:16px;
      background:linear-gradient(135deg, rgba(86,182,255,.95), rgba(182,146,255,.95));
      display:grid; place-items:center;
      font-weight:950; letter-spacing:.5px;
      box-shadow:0 10px 22px rgba(0,0,0,.22);
      user-select:none;
    }
    .sbtn{
      width:48px; height:48px; border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      display:grid; place-items:center;
      cursor:pointer; user-select:none;
      transition: transform .18s ease, background .18s ease;
      font-weight:950;
    }
    .sbtn:hover{ transform:translateY(-2px); background:rgba(255,255,255,.12) }
    .sbtn.active{ background:rgba(255,255,255,.18) }
    .spacer{ flex:1; }
    .avatar{
      width:48px;height:48px;border-radius:18px;
      background:linear-gradient(135deg, rgba(255,255,255,.24), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      font-weight:950;
    }

    /* Main */
    .main{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      border-radius:26px;
      padding:14px;
      overflow:hidden;
      display:flex; flex-direction:column; gap:12px;
    }

    .topbar{
      display:flex; gap:10px; align-items:center;
      padding:8px 8px 6px 8px;
      flex-wrap:wrap;
    }
    .search{
      flex:1; min-width:240px;
      display:flex; gap:10px; align-items:center;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,.10);
      border-radius:20px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
      color:var(--ink);
    }
    .search input{
      width:100%; border:0; outline:0; background:transparent;
      font-size:14px; color:var(--ink);
    }
    .chip{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
      cursor:pointer; user-select:none;
      transition: transform .18s ease, background .18s ease;
      white-space:nowrap;
    }
    .chip:hover{ transform:translateY(-2px); background:rgba(255,255,255,.14) }
    .dot{ width:9px;height:9px;border-radius:999px;background:var(--mint); box-shadow:0 0 0 4px rgba(124,240,200,.18); }
    .tiny{ font-size:12px; opacity:.92; }

    .grid{ display:grid; grid-template-columns: 1.35fr .85fr; gap:12px; align-items:stretch; }
    .bottom{ display:grid; grid-template-columns: 1fr 1fr .95fr; gap:12px; align-items:stretch; }

    .card{
      background:var(--card2);
      border:1px solid rgba(15,23,42,.10);
      border-radius:var(--r);
      box-shadow:var(--shadow2);
      color:var(--ink);
      overflow:hidden;
    }
    .pad{ padding:16px; }
    .muted{ color:var(--muted); font-size:12.5px; line-height:1.35; }
    h2,h3{ margin:0; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.70);
    }
    .kpis{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-top:12px; }
    .kpi{
      background:rgba(15,23,42,.03);
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      padding:12px;
      position:relative; overflow:hidden;
    }
    .kpi::after{
      content:"";
      position:absolute; inset:auto -40px -40px auto;
      width:140px;height:140px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(86,182,255,.32), transparent 60%);
      pointer-events:none;
    }
    .big{ font-size:28px; font-weight:950; margin:4px 0 0 0; }
    .btnRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.03);
      color:var(--ink);
      border-radius:14px;
      padding:10px 12px;
      font-weight:950;
      font-size:12px;
      cursor:pointer;
      transition: transform .18s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ transform:translateY(-2px); }
    .btn.primary{
      background:linear-gradient(135deg, rgba(47,140,255,.95), rgba(182,146,255,.90));
      color:#fff;
      border-color:rgba(47,140,255,.25);
      box-shadow:0 14px 26px rgba(47,140,255,.20);
    }
    .btn.danger{ background:rgba(255,123,176,.12); border-color:rgba(255,123,176,.20); }
    .btn.good{ background:rgba(124,240,200,.14); border-color:rgba(124,240,200,.22); }
    .btn.smallBtn{ padding:8px 10px; border-radius:12px; }

    /* Lists */
    .listHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .select{
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.03);
      border-radius:14px;
      padding:8px 10px;
      font-size:12px;
      color:var(--ink);
      outline:none;
      cursor:pointer;
      font-weight:900;
    }
    .plist{
      display:flex; flex-direction:column; gap:10px;
      max-height: 320px;
      overflow:auto;
      padding-right:4px;
    }
    .plist::-webkit-scrollbar{ width:10px; }
    .plist::-webkit-scrollbar-thumb{
      background: rgba(15,23,42,.10);
      border-radius: 999px;
      border:2px solid rgba(255,255,255,.55);
    }
    .pitem{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.72);
      cursor:pointer;
      transition: transform .18s ease, background .18s ease;
    }
    .pitem:hover{ transform: translateY(-2px); background: rgba(255,255,255,.86); }
    .pface{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background:linear-gradient(135deg, rgba(86,182,255,.35), rgba(255,123,176,.25));
      display:grid; place-items:center;
      font-weight:950;
      color:rgba(15,23,42,.70);
    }
    .pmeta{ flex:1; min-width:0; }
    .pname{ margin:0; font-weight:950; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .psub{ margin:0; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .ptime{
      font-size:12px; font-weight:950;
      color:rgba(15,23,42,.70);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.08);
      white-space:nowrap;
    }
    .tag{
      font-size:11px; font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.70);
      white-space:nowrap;
    }
    .tag.confirmado{ border-color: rgba(124,240,200,.35); background: rgba(124,240,200,.18); }
    .tag.pendente{ border-color: rgba(255,210,122,.35); background: rgba(255,210,122,.18); }
    .tag.falta{ border-color: rgba(255,123,176,.35); background: rgba(255,123,176,.16); }
    .tag.reagendado{ border-color: rgba(182,146,255,.35); background: rgba(182,146,255,.18); }

    /* Consultation */
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .field{
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.03);
      padding:10px;
    }
    .label{
      font-size:11px; color:rgba(15,23,42,.50);
      font-weight:950; letter-spacing:.2px;
      margin-bottom:6px;
    }
    .value{
      font-size:12.8px;
      color:rgba(15,23,42,.82);
      font-weight:900;
      line-height:1.3;
      word-break:break-word;
    }
    textarea{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.76);
      padding:10px;
      min-height:120px;
      outline:none;
      resize:vertical;
      font-family:var(--font);
      font-size:12.8px;
      color:rgba(15,23,42,.88);
      line-height:1.35;
    }

    /* Calendar */
    .scheduleHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .navBtn{
      width:34px;height:34px;border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.03);
      display:grid;place-items:center;
      cursor:pointer;
      transition: transform .18s ease;
      user-select:none;
      font-weight:950;
    }
    .navBtn:hover{ transform:translateY(-2px); }
    .cal{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      padding: 8px 2px 0 2px;
    }
    .dow{
      font-size:11px;
      color:rgba(15,23,42,.45);
      text-align:center;
      font-weight:950;
      padding:4px 0;
    }
    .day{
      font-size:12px;
      text-align:center;
      padding:8px 0;
      border-radius:12px;
      border:1px solid transparent;
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .day:hover{ background: rgba(86,182,255,.10); border-color: rgba(86,182,255,.18); }
    .day.muted{ color: rgba(15,23,42,.35); }
    .day.today{
      background: rgba(47,140,255,.14);
      border-color: rgba(47,140,255,.25);
      font-weight: 950;
    }
    .dotMini{
      position:absolute;
      width:6px;height:6px;border-radius:999px;
      bottom:6px; left:50%; transform:translateX(-50%);
      background: rgba(47,140,255,.65);
    }
    .upcoming{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(15,23,42,.15);
    }

    /* Attachments */
    .attachments{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .attList{ display:flex; flex-direction:column; gap:8px; max-height: 140px; overflow:auto; padding-right:4px; }
    .attItem{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.72);
    }
    .attItem b{ font-size:12.5px; }
    .attItem .muted{ font-size:12px; }
    .attItem .grow{ flex:1; min-width:0; }
    .attItem .grow div{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    input[type="file"]{
      border:1px dashed rgba(15,23,42,.20);
      padding:10px;
      border-radius:18px;
      background:rgba(15,23,42,.03);
      width:100%;
      cursor:pointer;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.40);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal{
      width: min(760px, 100%);
      background: rgba(255,255,255,.92);
      color: var(--ink);
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(12px);
    }
    .modal h3{ font-weight:950; }
    .gridForm{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .gridForm.one{ grid-template-columns: 1fr; }
    .inp{
      width:100%;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.90);
      outline:none;
      font-weight:800;
      color: rgba(15,23,42,.86);
    }
    .modalFooter{
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      margin-top:12px;
    }

    /* Print */
    @media print{
      body{ background:#fff !important; padding:0; }
      .shell, .app, .sidebar, .topbar, .grid, .bottom{ display:none !important; }
      .printArea{ display:block !important; }

      .printArea{
        padding:18px;
        font-family: var(--font);
        color:#111;
      }
      .printArea h1{ margin:0 0 8px 0; }
      .printArea .box{ border:1px solid #ddd; border-radius:14px; padding:12px; margin-top:10px; }
      .printArea .row{ display:flex; gap:10px; flex-wrap:wrap; }
      .printArea .row > div{ flex:1; min-width:220px; }
      .printArea .small{ color:#555; font-size:12px; }

      /* Docs styling */
      .printArea .docHead{ display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
      .printArea .docHead .box{ margin-top:0; }
      .printArea .docTitle{ font-size:18px; font-weight:900; margin:0 0 6px 0; }
      .printArea .docLine{ height:1px; background:#ddd; margin:10px 0; }
      .printArea .signature{
        margin-top: 18px;
        padding-top: 12px;
        border-top: 1px dashed #bbb;
        text-align:center;
      }
      .printArea .stamp{ font-size:12px; color:#555; margin-top:6px; }
    }

    /* Responsive */
    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .bottom{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
    }
    @media (max-width: 720px){
      body{ padding:14px; }
      .app{ grid-template-columns: 1fr; }
      .sidebar{ flex-direction:row; justify-content:space-between; }
      .spacer{ display:none; }
      .gridForm{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

  <div class="shell">
    <div class="app">
      <aside class="sidebar">
        <div class="brand">BTX</div>
        <div class="sbtn active" title="Dashboard">üè†</div>
        <div class="sbtn" title="Pacientes">üë•</div>
        <div class="sbtn" title="Agenda">üìÖ</div>
        <div class="sbtn" title="Backup">üß†</div>
        <div class="spacer"></div>
        <div class="avatar" title="Perfil">OA</div>
      </aside>

      <main class="main">

        <div class="topbar">
          <div class="search">
            <span style="opacity:.65">üîé</span>
            <input id="searchInput" placeholder="Buscar paciente, telefone, procedimento..." />
          </div>

          <div class="chip" id="clinicStatus">
            <div class="dot" id="statusDot"></div>
            <div>
              <div class="tiny" style="font-weight:950;">Cl√≠nica Online</div>
              <div class="tiny" style="opacity:.8;">Abaetetuba ‚Ä¢ PA</div>
            </div>
          </div>

          <div class="chip" id="btnNewPatient"><div style="font-weight:950;">‚ûï Paciente</div></div>
          <div class="chip" id="btnNewAppt"><div style="font-weight:950;">‚ûï Agendamento</div></div>
          <div class="chip" id="btnDocs"><div style="font-weight:950;">üìÑ Documentos</div></div>
          <div class="chip" id="btnPrint"><div style="font-weight:950;">üñ®Ô∏è Imprimir</div></div>
        </div>

        <section class="grid">
          <!-- Left -->
          <div class="card pad">
            <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
              <div>
                <div class="muted">Bom dia üëã</div>
                <h2 style="font-weight:950;">BTX Dental ‚Ä¢ Consult√≥rio</h2>
                <div class="muted">Pacientes, agenda, evolu√ß√£o, anexos e documentos (receita/atestado/or√ßamento/recibo) ‚Äî tudo offline.</div>
              </div>
              <div class="pill">Hoje: <b id="todayLabel">‚Äî</b></div>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="muted">Agendados (dia)</div>
                <div class="big" id="kpiDay">0</div>
              </div>
              <div class="kpi" style="background: rgba(86,182,255,.10); border-color: rgba(86,182,255,.18);">
                <div class="muted">Confirmados (dia)</div>
                <div class="big" id="kpiConf">0</div>
              </div>
              <div class="kpi" style="background: rgba(255,123,176,.10); border-color: rgba(255,123,176,.18);">
                <div class="muted">Faltas (m√™s)</div>
                <div class="big" id="kpiFaltas">0</div>
              </div>
            </div>

            <div style="margin-top:14px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div>
                <div class="muted">Paciente selecionado</div>
                <div style="font-weight:950;" id="selTitle">Nenhum</div>
                <div class="muted" id="selSub">Selecione na lista para ver/editar.</div>
              </div>
              <div class="btnRow">
                <button class="btn good" id="btnSaveNotes">üíæ Salvar evolu√ß√£o</button>
                <button class="btn" id="btnEditPatient">‚úèÔ∏è Editar</button>
                <button class="btn danger" id="btnDeletePatient">üóëÔ∏è Excluir</button>
              </div>
            </div>

            <div class="twoCol">
              <div class="field">
                <div class="label">Telefone</div>
                <div class="value" id="vPhone">‚Äî</div>
              </div>
              <div class="field">
                <div class="label">Plano</div>
                <div class="value" id="vPlan">‚Äî</div>
              </div>
              <div class="field">
                <div class="label">Nascimento</div>
                <div class="value" id="vBirth">‚Äî</div>
              </div>
              <div class="field">
                <div class="label">Observa√ß√µes do paciente</div>
                <div class="value" id="vObs">‚Äî</div>
              </div>
            </div>

            <div style="margin-top:10px;">
              <div class="label">Evolu√ß√£o cl√≠nica (salva no banco)</div>
              <textarea id="clinicalNotes" placeholder="Queixa, exame, conduta, materiais, retorno..."></textarea>
            </div>

            <div class="attachments">
              <div class="label">Anexos (foto/PDF) do paciente (salvos no IndexedDB)</div>
              <input id="fileInput" type="file" accept="image/*,application/pdf" />
              <div class="attList" id="attList"></div>
            </div>
          </div>

          <!-- Right -->
          <div class="card pad">
            <div class="scheduleHeader">
              <div>
                <div class="muted">Agenda</div>
                <div style="font-weight:950;" id="monthLabel">‚Äî</div>
              </div>
              <div style="display:flex; gap:8px;">
                <div class="navBtn" id="prevMonth">‚Äπ</div>
                <div class="navBtn" id="nextMonth">‚Ä∫</div>
              </div>
            </div>

            <div class="cal" id="calendar"></div>

            <div class="upcoming">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div style="font-weight:950;">Agendamentos do dia</div>
                <div class="pill" id="dayLabel">‚Äî</div>
              </div>
              <div class="plist" id="dayAppts" style="max-height:260px;"></div>
            </div>
          </div>
        </section>

        <section class="bottom">
          <!-- Patients -->
          <div class="card pad">
            <div class="listHeader">
              <div>
                <div class="muted">Pacientes</div>
                <div style="font-weight:950;">Lista</div>
              </div>
              <select class="select" id="patientSort">
                <option value="name">A-Z</option>
                <option value="created">Mais recentes</option>
              </select>
            </div>
            <div class="plist" id="patientList"></div>
          </div>

          <!-- Appointments -->
          <div class="card pad">
            <div class="listHeader">
              <div>
                <div class="muted">Agendamentos</div>
                <div style="font-weight:950;">Do m√™s</div>
              </div>
              <select class="select" id="apptFilter">
                <option value="all">Todos</option>
                <option value="confirmado">Confirmados</option>
                <option value="pendente">Pendentes</option>
                <option value="falta">Faltas</option>
                <option value="reagendado">Reagendado</option>
              </select>
            </div>
            <div class="plist" id="apptList" style="max-height:340px;"></div>
            <div class="muted" style="margin-top:10px;">
              Dica: segure no agendamento (ou clique com bot√£o direito no PC) pra mudar status r√°pido.
            </div>
          </div>

          <!-- Backup -->
          <div class="card pad">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
              <div>
                <div class="muted">Backup</div>
                <div style="font-weight:950;">Exportar / Importar</div>
                <div class="muted">Troca de aparelho sem perder nada.</div>
              </div>
              <div class="pill">Offline-first</div>
            </div>

            <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
              <button class="btn primary" id="btnExport">‚¨áÔ∏è Exportar backup (.json)</button>
              <label class="btn" style="justify-content:center;">
                ‚¨ÜÔ∏è Importar backup
                <input id="importInput" type="file" accept="application/json" style="display:none;">
              </label>
              <button class="btn danger" id="btnWipe">‚ö†Ô∏è Apagar tudo do aparelho</button>
              <div class="muted" id="dbStatus">Banco: ‚Äî</div>
            </div>
          </div>
        </section>

        <!-- Print area -->
        <div class="printArea" style="display:none;"></div>
      </main>
    </div>
  </div>

  <!-- Modal: Patient -->
  <div class="overlay" id="modalPatient">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 id="patientModalTitle">Novo paciente</h3>
        <button class="btn" id="closePatient">‚úñ</button>
      </div>

      <div class="gridForm">
        <div>
          <div class="label">Nome completo</div>
          <input class="inp" id="pName" placeholder="Ex.: Maria Silva" />
        </div>
        <div>
          <div class="label">Telefone</div>
          <input class="inp" id="pPhone" placeholder="(91) 9xxxx-xxxx" />
        </div>
        <div>
          <div class="label">Plano</div>
          <input class="inp" id="pPlan" placeholder="Particular / Conv√™nio" />
        </div>
        <div>
          <div class="label">Nascimento</div>
          <input class="inp" id="pBirth" type="date" />
        </div>
      </div>

      <div class="gridForm one">
        <div>
          <div class="label">Observa√ß√µes</div>
          <input class="inp" id="pObs" placeholder="Alergias, condi√ß√µes, prefer√™ncias, etc." />
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn" id="cancelPatient">Cancelar</button>
        <button class="btn primary" id="savePatient">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Appointment -->
  <div class="overlay" id="modalAppt">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3>Novo agendamento</h3>
        <button class="btn" id="closeAppt">‚úñ</button>
      </div>

      <div class="gridForm">
        <div>
          <div class="label">Paciente</div>
          <select class="inp" id="aPatient"></select>
        </div>
        <div>
          <div class="label">Data</div>
          <input class="inp" id="aDate" type="date" />
        </div>
        <div>
          <div class="label">Hora</div>
          <input class="inp" id="aTime" type="time" />
        </div>
        <div>
          <div class="label">Status</div>
          <select class="inp" id="aStatus">
            <option value="pendente">Pendente</option>
            <option value="confirmado">Confirmado</option>
            <option value="falta">Falta</option>
            <option value="reagendado">Reagendado</option>
          </select>
        </div>
      </div>

      <div class="gridForm one">
        <div>
          <div class="label">Procedimento / Motivo</div>
          <input class="inp" id="aProc" placeholder="Ex.: Profilaxia / Restaura√ß√£o / Endo..." />
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn" id="cancelAppt">Cancelar</button>
        <button class="btn primary" id="saveAppt">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Documentos -->
  <div class="overlay" id="modalDocs">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3>Documentos</h3>
        <button class="btn" id="closeDocs">‚úñ</button>
      </div>

      <div class="muted" style="margin-top:6px;">
        Gera documentos com os dados do paciente selecionado. Depois √© s√≥ imprimir ou ‚ÄúSalvar em PDF‚Äù.
      </div>

      <div class="gridForm" style="margin-top:10px;">
        <div>
          <div class="label">Tipo</div>
          <select class="inp" id="docType">
            <option value="receita">Receita</option>
            <option value="atestado">Atestado</option>
            <option value="orcamento">Or√ßamento</option>
            <option value="recibo">Recibo</option>
          </select>
        </div>
        <div>
          <div class="label">Data</div>
          <input class="inp" id="docDate" type="date" />
        </div>
      </div>

      <div class="gridForm">
        <div>
          <div class="label">Profissional (nome)</div>
          <input class="inp" id="proName" placeholder="Dr. Orlando Abreu" />
        </div>
        <div>
          <div class="label">Registro (CRO/CRM)</div>
          <input class="inp" id="proReg" placeholder="CRO-PA XXXXX" />
        </div>
        <div>
          <div class="label">Telefone/Contato</div>
          <input class="inp" id="proPhone" placeholder="(91) 99987-3835" />
        </div>
        <div>
          <div class="label">Endere√ßo</div>
          <input class="inp" id="proAddr" placeholder="Abaetetuba - PA" />
        </div>
      </div>

      <div class="gridForm one">
        <div>
          <div class="label">Conte√∫do do documento</div>
          <textarea id="docBody" style="min-height:160px;" placeholder="Digite o texto do documento..."></textarea>
          <div class="muted" style="margin-top:8px;">
            Dica: clique em ‚ÄúModelo‚Äù e s√≥ ajuste na hora.
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn" id="loadTemplate">‚ö° Modelo</button>
        <button class="btn primary" id="printDoc">üñ®Ô∏è Imprimir / PDF</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   BTX Dental ‚Ä¢ Offline-first (COM documentos)
   - IndexedDB: pacientes, agendamentos, anexos
   - CRUD real
   - Busca
   - Backup export/import
   - Impress√£o ficha + agenda
   - Documentos: Receita / Atestado / Or√ßamento / Recibo (print/PDF)
========================= */

/* ---------- Utils ---------- */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const todayISO = ()=> new Date().toISOString().slice(0,10);
const toBR = (iso)=> {
  if(!iso) return "‚Äî";
  const [y,m,d]=iso.split("-");
  return `${d}/${m}/${y}`;
};
const initials = (name)=>{
  const parts=(name||"").trim().split(/\\s+/).filter(Boolean);
  const a=parts[0]?.[0]||"P";
  const b=parts[1]?.[0]||parts[0]?.[1]||"X";
  return (a+b).toUpperCase();
};
function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function toast(msg){
  let t=$("#toast");
  if(!t){
    t=document.createElement("div");
    t.id="toast";
    t.style.cssText=`
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      padding:12px 14px; border-radius:999px;
      background:rgba(255,255,255,.88); color:rgba(15,23,42,.88);
      font-weight:950; border:1px solid rgba(15,23,42,.12);
      box-shadow:0 18px 40px rgba(0,0,0,.22); z-index:99999;
      backdrop-filter: blur(10px);
      transition: opacity .2s ease;
    `;
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.opacity="1";
  clearTimeout(window.__toastTimer);
  window.__toastTimer=setTimeout(()=>t.style.opacity="0", 2200);
}

/* ---------- IndexedDB ---------- */
const DB_NAME="btx_dental_db";
const DB_VER=1;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req=indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded=()=>{
      const db=req.result;

      if(!db.objectStoreNames.contains("patients")){
        const s=db.createObjectStore("patients",{keyPath:"id"});
        s.createIndex("name","name",{unique:false});
        s.createIndex("createdAt","createdAt",{unique:false});
      }
      if(!db.objectStoreNames.contains("appointments")){
        const s=db.createObjectStore("appointments",{keyPath:"id"});
        s.createIndex("date","date",{unique:false});
        s.createIndex("status","status",{unique:false});
        s.createIndex("patientId","patientId",{unique:false});
      }
      if(!db.objectStoreNames.contains("files")){
        const s=db.createObjectStore("files",{keyPath:"id"});
        s.createIndex("patientId","patientId",{unique:false});
        s.createIndex("createdAt","createdAt",{unique:false});
      }
      if(!db.objectStoreNames.contains("meta")){
        db.createObjectStore("meta",{keyPath:"key"});
      }
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function tx(store, mode="readonly"){
  const db=await openDB();
  return db.transaction(store, mode).objectStore(store);
}
async function put(store, value){
  const os=await tx(store,"readwrite");
  return new Promise((res,rej)=>{
    const r=os.put(value);
    r.onsuccess=()=>res(value);
    r.onerror=()=>rej(r.error);
  });
}
async function del(store, key){
  const os=await tx(store,"readwrite");
  return new Promise((res,rej)=>{
    const r=os.delete(key);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
async function get(store, key){
  const os=await tx(store,"readonly");
  return new Promise((res,rej)=>{
    const r=os.get(key);
    r.onsuccess=()=>res(r.result||null);
    r.onerror=()=>rej(r.error);
  });
}
async function getAll(store){
  const os=await tx(store,"readonly");
  return new Promise((res,rej)=>{
    const r=os.getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
async function clearStore(store){
  const os=await tx(store,"readwrite");
  return new Promise((res,rej)=>{
    const r=os.clear();
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function uid(){
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

/* ---------- State ---------- */
let state={
  patients:[],
  appointments:[],
  selectedPatientId:null,
  calDate:new Date(),
  selectedDay: todayISO(),
  online:true
};

/* ---------- Seed ---------- */
async function isFirstRun(){
  const m=await get("meta","seeded");
  return !m;
}
async function seedIfNeeded(){
  if(!(await isFirstRun())) return;

  const p1={id:uid(), name:"Paciente Exemplo", phone:"(91) 90000-0000", plan:"Particular", birth:"1990-01-01", obs:"Alergia: negar", clinicalNotes:"", createdAt:Date.now(), updatedAt:Date.now()};
  await put("patients", p1);

  const a1={id:uid(), patientId:p1.id, date:todayISO(), time:"09:00", status:"confirmado", proc:"Avalia√ß√£o + Plano", createdAt:Date.now()};
  await put("appointments", a1);

  await put("meta",{key:"seeded", value:true});
}

/* ---------- Load & Refresh ---------- */
async function loadAll(){
  await seedIfNeeded();
  state.patients=await getAll("patients");
  state.appointments=await getAll("appointments");
  $("#dbStatus").textContent = `Banco: ${state.patients.length} pacientes ‚Ä¢ ${state.appointments.length} agendamentos ‚Ä¢ IndexedDB OK ‚úÖ`;
}
function sortPatients(list, mode){
  const a=[...list];
  if(mode==="created") a.sort((x,y)=>(y.createdAt||0)-(x.createdAt||0));
  else a.sort((x,y)=>(x.name||"").localeCompare(y.name||""));
  return a;
}
function monthKey(d){
  const dt = new Date(d);
  const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

/* ---------- Render ---------- */
function renderHeader(){
  const now=new Date();
  const wd=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"][now.getDay()];
  $("#todayLabel").textContent = ` ${wd}, ${now.toLocaleDateString("pt-BR")} `;
  $("#dayLabel").textContent = toBR(state.selectedDay);
}
function apptsForMonth(ym){
  return state.appointments.filter(a => (a.date||"").startsWith(ym));
}
function apptsForDay(day){
  return state.appointments
    .filter(a => a.date===day)
    .sort((x,y)=>(x.time||"").localeCompare(y.time||""));
}

function renderPatients(){
  const list=$("#patientList");
  list.innerHTML="";
  const q=$("#searchInput").value.trim().toLowerCase();
  const mode=$("#patientSort").value;

  let arr=state.patients.filter(p=>{
    if(!q) return true;
    return (p.name||"").toLowerCase().includes(q) ||
           (p.phone||"").toLowerCase().includes(q) ||
           (p.plan||"").toLowerCase().includes(q) ||
           (p.obs||"").toLowerCase().includes(q);
  });

  arr=sortPatients(arr, mode);

  if(arr.length===0){
    const e=document.createElement("div");
    e.className="muted";
    e.style.padding="12px";
    e.textContent="Nenhum paciente encontrado.";
    list.appendChild(e);
    return;
  }

  arr.forEach(p=>{
    const el=document.createElement("div");
    el.className="pitem";
    el.dataset.id=p.id;
    el.innerHTML=`
      <div class="pface">${initials(p.name)}</div>
      <div class="pmeta">
        <p class="pname">${escapeHtml(p.name)}</p>
        <p class="psub">${escapeHtml(p.plan||"‚Äî")} ‚Ä¢ ${escapeHtml(p.phone||"‚Äî")}</p>
      </div>
      <div class="ptime">ü¶∑</div>
    `;
    el.addEventListener("click", ()=>selectPatient(p.id));
    if(p.id===state.selectedPatientId){
      el.style.outline="2px solid rgba(47,140,255,.35)";
    }
    list.appendChild(el);
  });
}

function renderAppts(){
  const list=$("#apptList");
  list.innerHTML="";
  const filter=$("#apptFilter").value;
  const ym = monthKey(state.calDate);

  let arr=apptsForMonth(ym);
  if(filter!=="all") arr=arr.filter(a=>a.status===filter);

  const q=$("#searchInput").value.trim().toLowerCase();
  if(q){
    arr=arr.filter(a=>{
      const p=state.patients.find(pp=>pp.id===a.patientId);
      return (a.proc||"").toLowerCase().includes(q) ||
             (a.status||"").toLowerCase().includes(q) ||
             (a.date||"").includes(q) ||
             (a.time||"").includes(q) ||
             (p?.name||"").toLowerCase().includes(q) ||
             (p?.phone||"").toLowerCase().includes(q);
    });
  }

  arr.sort((x,y)=>{
    if(x.date!==y.date) return (x.date||"").localeCompare(y.date||"");
    return (x.time||"").localeCompare(y.time||"");
  });

  if(arr.length===0){
    const e=document.createElement("div");
    e.className="muted";
    e.style.padding="12px";
    e.textContent="Sem agendamentos nesse filtro/m√™s.";
    list.appendChild(e);
    return;
  }

  arr.forEach(a=>{
    const p=state.patients.find(pp=>pp.id===a.patientId);
    const el=document.createElement("div");
    el.className="pitem";
    el.innerHTML=`
      <div class="pface">${initials(p?.name||"‚Äî")}</div>
      <div class="pmeta">
        <p class="pname">${escapeHtml(p?.name||"Paciente removido")}</p>
        <p class="psub">${escapeHtml(a.proc||"‚Äî")}</p>
      </div>
      <div class="tag ${a.status}">${(a.status||"").toUpperCase()}</div>
      <div class="ptime">${a.time||"‚Äî"}</div>
    `;
    el.addEventListener("click", ()=>{
      if(p?.id) selectPatient(p.id);
      state.selectedDay=a.date;
      renderDayAppts();
      $("#dayLabel").textContent=toBR(state.selectedDay);
      toast("Agendamento selecionado üìå");
      renderCalendar();
      renderKpis();
    });

    // mudan√ßa r√°pida de status
    const changeStatus = async ()=>{
      const next = prompt("Status: confirmado | pendente | falta | reagendado", a.status);
      if(!next) return;
      const ok=["confirmado","pendente","falta","reagendado"].includes(next);
      if(!ok) return toast("Status inv√°lido.");
      a.status=next;
      await put("appointments", a);
      await refresh();
      toast("Status atualizado ‚úÖ");
    };

    el.addEventListener("contextmenu", (ev)=>{ ev.preventDefault(); changeStatus(); });

    // mobile: toque longo
    let pressTimer=null;
    el.addEventListener("touchstart", ()=>{
      pressTimer=setTimeout(()=>changeStatus(), 650);
    }, {passive:true});
    el.addEventListener("touchend", ()=>{ clearTimeout(pressTimer); }, {passive:true});
    el.addEventListener("touchmove", ()=>{ clearTimeout(pressTimer); }, {passive:true});

    list.appendChild(el);
  });
}

function renderDayAppts(){
  const list=$("#dayAppts");
  list.innerHTML="";
  const arr=apptsForDay(state.selectedDay);

  if(arr.length===0){
    const e=document.createElement("div");
    e.className="muted";
    e.style.padding="12px";
    e.textContent="Sem agendamentos nesse dia.";
    list.appendChild(e);
    return;
  }

  arr.forEach(a=>{
    const p=state.patients.find(pp=>pp.id===a.patientId);
    const el=document.createElement("div");
    el.className="pitem";
    el.innerHTML=`
      <div class="pface">${initials(p?.name||"‚Äî")}</div>
      <div class="pmeta">
        <p class="pname">${escapeHtml(p?.name||"Paciente removido")}</p>
        <p class="psub">${escapeHtml(a.proc||"‚Äî")}</p>
      </div>
      <div class="tag ${a.status}">${(a.status||"").toUpperCase()}</div>
      <div class="ptime">${a.time||"‚Äî"}</div>
    `;
    el.addEventListener("click", ()=>{ if(p?.id) selectPatient(p.id); });
    list.appendChild(el);
  });
}

function renderCalendar(){
  const cal=$("#calendar");
  cal.innerHTML="";

  const year=state.calDate.getFullYear();
  const month=state.calDate.getMonth();
  const monthNames=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  $("#monthLabel").textContent = `${monthNames[month]} ${year}`;

  const dows=["D","S","T","Q","Q","S","S"];
  dows.forEach(d=>{
    const el=document.createElement("div");
    el.className="dow";
    el.textContent=d;
    cal.appendChild(el);
  });

  const first=new Date(year, month, 1);
  const last=new Date(year, month+1, 0);
  const startDay=first.getDay();
  const totalDays=last.getDate();

  const prevLast=new Date(year, month, 0).getDate();
  for(let i=0;i<startDay;i++){
    const el=document.createElement("div");
    el.className="day muted";
    el.textContent=(prevLast-startDay+1+i);
    cal.appendChild(el);
  }

  const today=new Date();
  const ym = `${year}-${String(month+1).padStart(2,"0")}`;
  const arrMonth=apptsForMonth(ym);

  for(let d=1; d<=totalDays; d++){
    const el=document.createElement("div");
    el.className="day";
    el.textContent=d;

    const isToday=(d===today.getDate() && month===today.getMonth() && year===today.getFullYear());
    if(isToday) el.classList.add("today");

    const iso = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const hasAppt = arrMonth.some(a=>a.date===iso);
    if(hasAppt){
      const dot=document.createElement("div");
      dot.className="dotMini";
      el.appendChild(dot);
    }

    if(iso===state.selectedDay){
      el.style.outline="2px solid rgba(47,140,255,.35)";
      el.style.background="rgba(47,140,255,.10)";
    }

    el.addEventListener("click", ()=>{
      state.selectedDay=iso;
      $("#dayLabel").textContent=toBR(state.selectedDay);
      renderCalendar();
      renderDayAppts();
      renderKpis();
    });

    cal.appendChild(el);
  }

  const cells=cal.children.length;
  const needed=(7*7)-cells;
  for(let i=0;i<Math.max(0,needed);i++){
    const el=document.createElement("div");
    el.className="day muted";
    el.textContent=(i+1);
    cal.appendChild(el);
  }
}

function renderSelectedPatient(){
  const p=state.patients.find(x=>x.id===state.selectedPatientId);
  if(!p){
    $("#selTitle").textContent="Nenhum";
    $("#selSub").textContent="Selecione na lista para ver/editar.";
    $("#vPhone").textContent="‚Äî";
    $("#vPlan").textContent="‚Äî";
    $("#vBirth").textContent="‚Äî";
    $("#vObs").textContent="‚Äî";
    $("#clinicalNotes").value="";
    $("#attList").innerHTML="";
    return;
  }
  $("#selTitle").textContent=p.name;
  $("#selSub").textContent=`Criado em ${new Date(p.createdAt||Date.now()).toLocaleDateString("pt-BR")}`;
  $("#vPhone").textContent=p.phone||"‚Äî";
  $("#vPlan").textContent=p.plan||"‚Äî";
  $("#vBirth").textContent=p.birth ? toBR(p.birth) : "‚Äî";
  $("#vObs").textContent=p.obs||"‚Äî";
  $("#clinicalNotes").value=p.clinicalNotes||"";
}

async function renderAttachments(){
  const pId=state.selectedPatientId;
  const list=$("#attList");
  list.innerHTML="";
  if(!pId) return;

  const all=await getAll("files");
  const files=all.filter(f=>f.patientId===pId).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  if(files.length===0){
    const e=document.createElement("div");
    e.className="muted";
    e.style.padding="12px";
    e.textContent="Sem anexos para este paciente.";
    list.appendChild(e);
    return;
  }

  files.forEach(f=>{
    const el=document.createElement("div");
    el.className="attItem";
    const sizeKB = Math.round((f.size||0)/1024);
    el.innerHTML=`
      <div class="pface">üìé</div>
      <div class="grow">
        <div><b>${escapeHtml(f.name||"arquivo")}</b></div>
        <div class="muted">${escapeHtml(f.type||"")} ‚Ä¢ ${sizeKB} KB ‚Ä¢ ${new Date(f.createdAt).toLocaleString("pt-BR")}</div>
      </div>
      <button class="btn smallBtn" data-open="${f.id}">Abrir</button>
      <button class="btn danger smallBtn" data-del="${f.id}">Excluir</button>
    `;

    el.querySelector(`[data-open="${f.id}"]`).addEventListener("click", async ()=>{
      const fx=await get("files", f.id);
      if(!fx) return toast("Arquivo n√£o encontrado.");
      const url = URL.createObjectURL(fx.blob);
      window.open(url, "_blank");
      setTimeout(()=>URL.revokeObjectURL(url), 60_000);
    });

    el.querySelector(`[data-del="${f.id}"]`).addEventListener("click", async ()=>{
      if(!confirm("Excluir este anexo?")) return;
      await del("files", f.id);
      await renderAttachments();
      toast("Anexo exclu√≠do üóëÔ∏è");
    });

    list.appendChild(el);
  });
}

function renderKpis(){
  const day=state.selectedDay;
  const dayAppts=apptsForDay(day);
  const conf=dayAppts.filter(a=>a.status==="confirmado").length;

  const ym = monthKey(state.calDate);
  const faltas=apptsForMonth(ym).filter(a=>a.status==="falta").length;

  $("#kpiDay").textContent = dayAppts.length;
  $("#kpiConf").textContent = conf;
  $("#kpiFaltas").textContent = faltas;
}

/* ---------- Modals ---------- */
function openModal(sel){ $(sel).style.display="flex"; }
function closeModal(sel){ $(sel).style.display="none"; }

/* ---------- Actions ---------- */
async function refresh(){
  await loadAll();
  renderHeader();
  renderPatients();
  renderSelectedPatient();
  await renderAttachments();
  renderCalendar();
  renderDayAppts();
  renderAppts();
  renderKpis();
}

async function selectPatient(id){
  state.selectedPatientId=id;
  renderPatients();
  renderSelectedPatient();
  await renderAttachments();
  await fillPatientSelect();
}

/* ---------- Patients CRUD ---------- */
let editingPatientId=null;

function resetPatientForm(){
  $("#pName").value="";
  $("#pPhone").value="";
  $("#pPlan").value="";
  $("#pBirth").value="";
  $("#pObs").value="";
  editingPatientId=null;
  $("#patientModalTitle").textContent="Novo paciente";
}

async function savePatientFromModal(){
  const name=$("#pName").value.trim();
  if(!name) return toast("Nome √© obrigat√≥rio.");
  const phone=$("#pPhone").value.trim();
  const plan=$("#pPlan").value.trim();
  const birth=$("#pBirth").value || "";
  const obs=$("#pObs").value.trim();

  if(editingPatientId){
    const p=await get("patients", editingPatientId);
    if(!p) return toast("Paciente n√£o encontrado.");
    p.name=name; p.phone=phone; p.plan=plan; p.birth=birth; p.obs=obs; p.updatedAt=Date.now();
    await put("patients", p);
    state.selectedPatientId=p.id;
    toast("Paciente atualizado ‚úÖ");
  }else{
    const p={id:uid(), name, phone, plan, birth, obs, clinicalNotes:"", createdAt:Date.now(), updatedAt:Date.now()};
    await put("patients", p);
    state.selectedPatientId=p.id;
    toast("Paciente cadastrado ‚úÖ");
  }
  closeModal("#modalPatient");
  await refresh();
}

async function deleteSelectedPatient(){
  const id=state.selectedPatientId;
  if(!id) return toast("Selecione um paciente.");
  const p=state.patients.find(x=>x.id===id);
  if(!confirm(`Excluir paciente "${p?.name||""}" e todos os seus anexos/agendamentos?`)) return;

  const files=await getAll("files");
  for(const f of files.filter(f=>f.patientId===id)) await del("files", f.id);

  const ap=await getAll("appointments");
  for(const a of ap.filter(a=>a.patientId===id)) await del("appointments", a.id);

  await del("patients", id);
  state.selectedPatientId=null;
  toast("Paciente removido üóëÔ∏è");
  await refresh();
}

async function saveClinicalNotes(){
  const id=state.selectedPatientId;
  if(!id) return toast("Selecione um paciente.");
  const p=await get("patients", id);
  if(!p) return toast("Paciente n√£o encontrado.");
  p.clinicalNotes=$("#clinicalNotes").value || "";
  p.updatedAt=Date.now();
  await put("patients", p);
  toast("Evolu√ß√£o salva üíæ");
  await refresh();
}

/* ---------- Attachments ---------- */
async function handleFileUpload(file){
  const pId=state.selectedPatientId;
  if(!pId) return toast("Selecione um paciente antes de anexar.");
  if(!file) return;

  const MAX_MB = 12;
  if(file.size > MAX_MB * 1024 * 1024) return toast(`Arquivo grande demais (${MAX_MB}MB m√°x).`);

  const record={
    id:uid(),
    patientId:pId,
    name:file.name,
    type:file.type,
    size:file.size,
    createdAt:Date.now(),
    blob:file
  };
  await put("files", record);
  toast("Anexo salvo üìé");
  await renderAttachments();
}

/* ---------- Appointments ---------- */
async function fillPatientSelect(){
  const sel=$("#aPatient");
  sel.innerHTML="";
  const arr=sortPatients(state.patients, "name");
  arr.forEach(p=>{
    const op=document.createElement("option");
    op.value=p.id;
    op.textContent=p.name;
    sel.appendChild(op);
  });
  if(state.selectedPatientId) sel.value=state.selectedPatientId;
}

async function saveApptFromModal(){
  const patientId=$("#aPatient").value;
  const date=$("#aDate").value;
  const time=$("#aTime").value;
  const status=$("#aStatus").value;
  const proc=$("#aProc").value.trim();

  if(!patientId) return toast("Selecione o paciente.");
  if(!date) return toast("Data √© obrigat√≥ria.");
  if(!time) return toast("Hora √© obrigat√≥ria.");
  if(!proc) return toast("Procedimento √© obrigat√≥rio.");

  const a={ id:uid(), patientId, date, time, status, proc, createdAt:Date.now() };
  await put("appointments", a);

  state.selectedDay=date;
  state.calDate = new Date(date+"T00:00:00");
  toast("Agendamento criado ‚úÖ");
  closeModal("#modalAppt");
  await refresh();
}

/* ---------- Print (Ficha + Agenda) ---------- */
function buildPrintHTML(){
  const p=state.patients.find(x=>x.id===state.selectedPatientId);
  const day=state.selectedDay;
  const ap=apptsForDay(day);

  const clinicInfo = `
    <div class="small">BTX Dental ‚Ä¢ Consult√≥rio Offline</div>
    <div class="small">Abaetetuba - PA</div>
  `;

  const patientBox = p ? `
    <div class="box">
      <h2 style="margin:0 0 8px 0;">Ficha do Paciente</h2>
      <div class="row">
        <div><b>Nome:</b> ${escapeHtml(p.name)}</div>
        <div><b>Telefone:</b> ${escapeHtml(p.phone||"‚Äî")}</div>
        <div><b>Plano:</b> ${escapeHtml(p.plan||"‚Äî")}</div>
        <div><b>Nascimento:</b> ${p.birth?toBR(p.birth):"‚Äî"}</div>
      </div>
      <div class="box" style="margin-top:10px;">
        <div><b>Observa√ß√µes:</b> ${escapeHtml(p.obs||"‚Äî")}</div>
      </div>
      <div class="box" style="margin-top:10px;">
        <div><b>Evolu√ß√£o cl√≠nica:</b></div>
        <div class="small" style="white-space:pre-wrap; margin-top:6px;">${escapeHtml(p.clinicalNotes||"‚Äî")}</div>
      </div>
    </div>
  ` : `
    <div class="box">
      <h2 style="margin:0 0 6px 0;">Ficha do Paciente</h2>
      <div class="small">Nenhum paciente selecionado.</div>
    </div>
  `;

  const apptBox = `
    <div class="box">
      <h2 style="margin:0 0 8px 0;">Agenda do Dia ‚Ä¢ ${toBR(day)}</h2>
      ${ap.length ? ap.map(a=>{
        const pp=state.patients.find(x=>x.id===a.patientId);
        return `<div class="box" style="margin-top:10px;">
          <div class="row">
            <div><b>Hora:</b> ${escapeHtml(a.time||"‚Äî")}</div>
            <div><b>Status:</b> ${escapeHtml((a.status||"").toUpperCase())}</div>
            <div><b>Paciente:</b> ${escapeHtml(pp?.name||"Paciente removido")}</div>
          </div>
          <div class="small" style="margin-top:6px;"><b>Procedimento:</b> ${escapeHtml(a.proc||"‚Äî")}</div>
        </div>`;
      }).join("") : `<div class="small">Sem agendamentos.</div>`}
    </div>
  `;

  return `
    <div>
      <h1 style="margin:0;">BTX Dental</h1>
      ${clinicInfo}
      ${patientBox}
      ${apptBox}
    </div>
  `;
}

function doPrint(){
  const area=$(".printArea");
  area.innerHTML = buildPrintHTML();
  window.print();
}

/* ---------- Documentos ---------- */
function templateFor(type){
  const p = state.patients.find(x=>x.id===state.selectedPatientId);
  const pname = p?.name || "Paciente";
  const pphone = p?.phone || "‚Äî";
  const dateBr = new Date().toLocaleDateString("pt-BR");

  if(type==="receita"){
    return `PACIENTE: ${pname}\nCONTATO: ${pphone}\nDATA: ${dateBr}\n\nPRESCRI√á√ÉO:\n1) ________________________________\n   Posologia: ______________________\n\n2) ________________________________\n   Posologia: ______________________\n\nORIENTA√á√ïES:\n- ________________________________\n- ________________________________\n`;
  }
  if(type==="atestado"){
    return `Atesto para os devidos fins que ${pname} esteve sob meus cuidados profissionais nesta data (${dateBr}), devendo permanecer afastado(a) de suas atividades por ____ dia(s), a contar de ____/____/____.\n\nCID (opcional): ________\nObserva√ß√µes: _____________________________\n`;
  }
  if(type==="orcamento"){
    return `OR√áAMENTO ODONTOL√ìGICO\nPaciente: ${pname}\nData: ${dateBr}\n\nItens/Procedimentos:\n1) ____________________________  R$ ________\n2) ____________________________  R$ ________\n3) ____________________________  R$ ________\n\nCondi√ß√µes:\n- Forma de pagamento: ____________________\n- Validade deste or√ßamento: ____ dias\n`;
  }
  if(type==="recibo"){
    return `RECIBO\nRecebi de ${pname} a quantia de R$ ________ (________________________), referente a servi√ßos odontol√≥gicos prestados.\n\nData: ${dateBr}\nForma de pagamento: ______________________\n`;
  }
  return "";
}

function openDocsModal(){
  const p = state.patients.find(x=>x.id===state.selectedPatientId);
  if(!p) return toast("Selecione um paciente.");

  $("#docDate").value = todayISO();

  // voc√™ edita isso uma vez e fica preenchendo depois
  $("#proName").value = $("#proName").value || "Dr. Orlando Abreu";
  $("#proReg").value  = $("#proReg").value  || "CRO-PA ______";
  $("#proPhone").value= $("#proPhone").value|| "(91) 99987-3835";
  $("#proAddr").value = $("#proAddr").value || "Abaetetuba - PA";

  $("#docType").value = $("#docType").value || "receita";
  $("#docBody").value = templateFor($("#docType").value);

  openModal("#modalDocs");
}

function printDocumentFromModal(){
  const p = state.patients.find(x=>x.id===state.selectedPatientId);
  if(!p) return toast("Selecione um paciente.");

  const type = $("#docType").value;
  const date = $("#docDate").value || todayISO();
  const dateBr = toBR(date);

  const proName = $("#proName").value || "Profissional";
  const proReg  = $("#proReg").value || "Registro";
  const proPhone= $("#proPhone").value || "";
  const proAddr = $("#proAddr").value || "";

  const titleMap = { receita:"Receita", atestado:"Atestado", orcamento:"Or√ßamento", recibo:"Recibo" };
  const body = $("#docBody").value || "";

  const area = document.querySelector(".printArea");
  area.innerHTML = `
    <div>
      <div class="docHead">
        <div class="box" style="flex:1;">
          <div class="docTitle">BTX Dental ‚Ä¢ ${titleMap[type] || "Documento"}</div>
          <div class="small"><b>Data:</b> ${dateBr}</div>
          <div class="small"><b>Paciente:</b> ${escapeHtml(p.name || "‚Äî")}</div>
          <div class="small"><b>Telefone:</b> ${escapeHtml(p.phone || "‚Äî")}</div>
        </div>
        <div class="box" style="flex:1;">
          <div class="small"><b>Profissional:</b> ${escapeHtml(proName)}</div>
          <div class="small"><b>Registro:</b> ${escapeHtml(proReg)}</div>
          <div class="small"><b>Contato:</b> ${escapeHtml(proPhone)}</div>
          <div class="small"><b>Endere√ßo:</b> ${escapeHtml(proAddr)}</div>
        </div>
      </div>

      <div class="docLine"></div>

      <div class="box">
        <div style="white-space:pre-wrap; font-size:13px; line-height:1.5;">
          ${escapeHtml(body)}
        </div>
      </div>

      <div class="signature">
        <div><b>${escapeHtml(proName)}</b></div>
        <div class="stamp">${escapeHtml(proReg)} ‚Ä¢ ${escapeHtml(proPhone)}</div>
      </div>
    </div>
  `;

  window.print();
}

/* ---------- Backup export/import ---------- */
function blobToBase64(blob){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=()=>rej(r.error);
    r.readAsDataURL(blob);
  });
}
function base64ToBlob(dataUrl){
  const [meta,b64]=dataUrl.split(",");
  const mime=(meta.match(/data:(.*?);base64/)||[])[1] || "application/octet-stream";
  const bin=atob(b64);
  const len=bin.length;
  const arr=new Uint8Array(len);
  for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i);
  return new Blob([arr], {type:mime});
}
async function exportBackup(){
  toast("Preparando backup‚Ä¶");
  const patients=await getAll("patients");
  const appointments=await getAll("appointments");
  const files=await getAll("files");

  const filesPacked=[];
  for(const f of files){
    const dataUrl=await blobToBase64(f.blob);
    filesPacked.push({
      id:f.id, patientId:f.patientId, name:f.name, type:f.type, size:f.size, createdAt:f.createdAt,
      dataUrl
    });
  }

  const payload={
    app:"BTX Dental",
    exportedAt:new Date().toISOString(),
    patients, appointments,
    files: filesPacked
  };

  const blob=new Blob([JSON.stringify(payload)], {type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`btx_dental_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 30_000);
  toast("Backup exportado ‚úÖ");
}
async function importBackup(file){
  if(!file) return;
  const txt=await file.text();
  let data=null;
  try{ data=JSON.parse(txt); }catch(e){ return toast("JSON inv√°lido."); }
  if(!data || data.app!=="BTX Dental") return toast("Backup n√£o reconhecido.");
  if(!confirm("Importar backup vai MESCLAR com o que j√° existe. Quer continuar?")) return;

  for(const p of (data.patients||[])) await put("patients", p);
  for(const a of (data.appointments||[])) await put("appointments", a);

  for(const f of (data.files||[])){
    const blob=base64ToBlob(f.dataUrl);
    await put("files", {id:f.id, patientId:f.patientId, name:f.name, type:f.type, size:f.size, createdAt:f.createdAt, blob});
  }

  toast("Backup importado ‚úÖ");
  await refresh();
}

/* ---------- Wipe ---------- */
async function wipeAll(){
  if(!confirm("Isso vai APAGAR tudo deste aparelho (pacientes, agenda, anexos). Tem certeza?")) return;
  await clearStore("patients");
  await clearStore("appointments");
  await clearStore("files");
  await clearStore("meta");
  state.selectedPatientId=null;
  toast("Tudo apagado ‚ö†Ô∏è");
  await refresh();
}

/* ---------- Events ---------- */
function bindEvents(){
  $("#searchInput").addEventListener("input", ()=>{
    renderPatients();
    renderAppts();
    renderDayAppts();
  });

  $("#patientSort").addEventListener("change", renderPatients);
  $("#apptFilter").addEventListener("change", renderAppts);

  $("#prevMonth").addEventListener("click", ()=>{
    state.calDate=new Date(state.calDate.getFullYear(), state.calDate.getMonth()-1, 1);
    renderCalendar(); renderAppts(); renderKpis();
  });
  $("#nextMonth").addEventListener("click", ()=>{
    state.calDate=new Date(state.calDate.getFullYear(), state.calDate.getMonth()+1, 1);
    renderCalendar(); renderAppts(); renderKpis();
  });

  $("#btnNewPatient").addEventListener("click", ()=>{
    resetPatientForm();
    openModal("#modalPatient");
  });
  $("#closePatient").addEventListener("click", ()=>closeModal("#modalPatient"));
  $("#cancelPatient").addEventListener("click", ()=>closeModal("#modalPatient"));
  $("#savePatient").addEventListener("click", savePatientFromModal);

  $("#btnEditPatient").addEventListener("click", async ()=>{
    if(!state.selectedPatientId) return toast("Selecione um paciente.");
    const p=await get("patients", state.selectedPatientId);
    if(!p) return toast("Paciente n√£o encontrado.");
    editingPatientId=p.id;
    $("#patientModalTitle").textContent="Editar paciente";
    $("#pName").value=p.name||"";
    $("#pPhone").value=p.phone||"";
    $("#pPlan").value=p.plan||"";
    $("#pBirth").value=p.birth||"";
    $("#pObs").value=p.obs||"";
    openModal("#modalPatient");
  });

  $("#btnDeletePatient").addEventListener("click", deleteSelectedPatient);
  $("#btnSaveNotes").addEventListener("click", saveClinicalNotes);

  $("#btnNewAppt").addEventListener("click", async ()=>{
    await fillPatientSelect();
    $("#aDate").value = state.selectedDay || todayISO();
    $("#aTime").value = "09:00";
    $("#aProc").value = "";
    $("#aStatus").value = "pendente";
    openModal("#modalAppt");
  });
  $("#closeAppt").addEventListener("click", ()=>closeModal("#modalAppt"));
  $("#cancelAppt").addEventListener("click", ()=>closeModal("#modalAppt"));
  $("#saveAppt").addEventListener("click", saveApptFromModal);

  $("#fileInput").addEventListener("change", async (e)=>{
    const file=e.target.files?.[0];
    e.target.value="";
    await handleFileUpload(file);
  });

  $("#btnPrint").addEventListener("click", doPrint);

  // Documentos
  $("#btnDocs").addEventListener("click", ()=>{
    if(!state.selectedPatientId) return toast("Selecione um paciente para gerar documentos.");
    openDocsModal();
  });
  $("#closeDocs").addEventListener("click", ()=>closeModal("#modalDocs"));
  $("#loadTemplate").addEventListener("click", ()=>{
    $("#docBody").value = templateFor($("#docType").value);
    toast("Modelo carregado ‚ö°");
  });
  $("#docType").addEventListener("change", ()=>{
    $("#docBody").value = templateFor($("#docType").value);
  });
  $("#printDoc").addEventListener("click", printDocumentFromModal);

  $("#btnExport").addEventListener("click", exportBackup);
  $("#importInput").addEventListener("change", async (e)=>{
    const file=e.target.files?.[0];
    e.target.value="";
    await importBackup(file);
  });
  $("#btnWipe").addEventListener("click", wipeAll);

  // status toggle
  $("#clinicStatus").addEventListener("click", ()=>{
    state.online=!state.online;
    const dot=$("#statusDot");
    if(state.online){
      dot.style.background="var(--mint)";
      dot.style.boxShadow="0 0 0 4px rgba(124,240,200,.18)";
      toast("Cl√≠nica Online ‚úÖ");
    }else{
      dot.style.background="var(--amber)";
      dot.style.boxShadow="0 0 0 4px rgba(255,210,122,.18)";
      toast("Modo Pausa ‚è∏Ô∏è");
    }
  });

  // fechar modal clicando fora
  ["modalPatient","modalAppt","modalDocs"].forEach(id=>{
    $("#"+id).addEventListener("click", (e)=>{
      if(e.target.id===id) closeModal("#"+id);
    });
  });

  // atalho salvar evolu√ß√£o
  document.addEventListener("keydown", (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){
      e.preventDefault();
      saveClinicalNotes();
    }
  });
}

/* ---------- Init ---------- */
async function init(){
  try{
    await refresh();
    bindEvents();

    if(!state.selectedPatientId && state.patients[0]){
      await selectPatient(state.patients[0].id);
    }

    state.selectedDay = todayISO();
    state.calDate = new Date(state.selectedDay+"T00:00:00");
    renderHeader(); renderCalendar(); renderDayAppts(); renderAppts(); renderKpis();

    // SW para PWA/offline
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("sw.js").catch(()=>{});
    }
  }catch(err){
    console.error(err);
    toast("Erro ao iniciar. Veja o console.");
    $("#dbStatus").textContent = "Erro ao abrir IndexedDB (modo privado pode bloquear).";
  }
}

init();
</script>
</body>
</html>
